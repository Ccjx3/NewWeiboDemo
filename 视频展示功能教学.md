# SwiftUI è§†é¢‘å±•ç¤ºåŠŸèƒ½æ•™å­¦æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [æ–¹æ¡ˆè®¾è®¡](#æ–¹æ¡ˆè®¾è®¡)
3. [æŠ€æœ¯é€‰å‹](#æŠ€æœ¯é€‰å‹)
4. [æ•°æ®æ¨¡å‹è®¾è®¡](#æ•°æ®æ¨¡å‹è®¾è®¡)
5. [è§†é¢‘æ’­æ”¾å™¨å®ç°](#è§†é¢‘æ’­æ”¾å™¨å®ç°)
6. [UI é›†æˆ](#ui-é›†æˆ)
7. [æºç å®ç°é€»è¾‘](#æºç å®ç°é€»è¾‘)
8. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
9. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## åŠŸèƒ½æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ç±»ä¼¼å¾®åšã€æœ‹å‹åœˆçš„è§†é¢‘å±•ç¤ºåŠŸèƒ½ï¼Œæ”¯æŒï¼š

- âœ… åœ¨å¸–å­åˆ—è¡¨ä¸­å±•ç¤ºè§†é¢‘å†…å®¹
- âœ… è‡ªåŠ¨æ’­æ”¾å’Œå¾ªç¯æ’­æ”¾
- âœ… æ’­æ”¾/æš‚åœæ§åˆ¶
- âœ… åŠ è½½çŠ¶æ€æç¤º
- âœ… é”™è¯¯å¤„ç†
- âœ… è§†é¢‘ä¸å›¾ç‰‡å†…å®¹çš„æ™ºèƒ½åˆ‡æ¢
- âœ… 16:9 æ ‡å‡†è§†é¢‘æ¯”ä¾‹

---

## æ–¹æ¡ˆè®¾è®¡

### 1. æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Post æ•°æ®æ¨¡å‹                  â”‚
â”‚  - åŸºç¡€ä¿¡æ¯ï¼ˆç”¨æˆ·ã€æ–‡æœ¬ç­‰ï¼‰               â”‚
â”‚  - å›¾ç‰‡æ•°ç»„ (images)                     â”‚
â”‚  - è§†é¢‘ URL (videoUrl) â† æ–°å¢            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PostCellView å¸–å­å•å…ƒæ ¼          â”‚
â”‚  - ç”¨æˆ·ä¿¡æ¯åŒº                            â”‚
â”‚  - æ–‡æœ¬å†…å®¹åŒº                            â”‚
â”‚  - åª’ä½“å†…å®¹åŒº â† æ ¸å¿ƒæ”¹åŠ¨                 â”‚
â”‚    â”œâ”€ ä¼˜å…ˆæ˜¾ç¤ºè§†é¢‘ï¼ˆå¦‚æœæœ‰ï¼‰             â”‚
â”‚    â””â”€ å¦åˆ™æ˜¾ç¤ºå›¾ç‰‡ç½‘æ ¼                   â”‚
â”‚  - äº’åŠ¨å·¥å…·æ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PostVideoPlayer è§†é¢‘æ’­æ”¾å™¨          â”‚
â”‚  - AVPlayer æ ¸å¿ƒæ’­æ”¾                     â”‚
â”‚  - è‡ªå®šä¹‰æ§åˆ¶ç•Œé¢                        â”‚
â”‚  - åŠ è½½çŠ¶æ€ç®¡ç†                          â”‚
â”‚  - é”™è¯¯å¤„ç†                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ˜¾ç¤ºä¼˜å…ˆçº§ç­–ç•¥

```
å¸–å­å†…å®¹åˆ¤æ–­æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Post å¯¹è±¡   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ hasVideo? â”€â”€Yesâ”€â”€â†’ æ˜¾ç¤ºè§†é¢‘æ’­æ”¾å™¨
       â”‚                     (éšè—å›¾ç‰‡)
       â”‚
       â””â”€ No â”€â”€â†’ images.isEmpty? â”€â”€Noâ”€â”€â†’ æ˜¾ç¤ºå›¾ç‰‡ç½‘æ ¼
                                   â”‚
                                   â””â”€ Yes â”€â”€â†’ ä»…æ˜¾ç¤ºæ–‡æœ¬
```

### 3. è§†é¢‘åŠ è½½ç­–ç•¥

```
è§†é¢‘ URL å¤„ç†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  videoUrl å­—æ®µ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ å®Œæ•´ URL? (http/https)
         â”‚   â””â”€â†’ ç›´æ¥ä½¿ç”¨
         â”‚
         â””â”€ æ–‡ä»¶å?
             â””â”€â†’ æ‹¼æ¥åŸºç¡€ URL
                 (https://weibo.com/tv/show/ + æ–‡ä»¶å)
```

---

## æŠ€æœ¯é€‰å‹

### ä¸ºä»€ä¹ˆé€‰æ‹© AVKit çš„ VideoPlayerï¼Ÿ

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **AVKit VideoPlayer** âœ… | â€¢ ç³»ç»ŸåŸç”Ÿï¼Œæ€§èƒ½ä¼˜ç§€<br>â€¢ è‡ªå¸¦å®Œæ•´æ§åˆ¶æ <br>â€¢ ä»£ç ç®€æ´<br>â€¢ è‡ªåŠ¨å¤„ç†æ’­æ”¾çŠ¶æ€ | â€¢ è‡ªå®šä¹‰èƒ½åŠ›æœ‰é™ | **ç¤¾äº¤åª’ä½“è§†é¢‘å±•ç¤º**<br>ï¼ˆæ¨èï¼‰ |
| AVPlayerLayer | â€¢ å®Œå…¨è‡ªå®šä¹‰<br>â€¢ çµæ´»æ€§é«˜ | â€¢ ä»£ç å¤æ‚<br>â€¢ éœ€æ‰‹åŠ¨å®ç°æ§åˆ¶ | ä¸“ä¸šè§†é¢‘åº”ç”¨ |
| WebView | â€¢ æ”¯æŒå¤šç§æ ¼å¼ | â€¢ æ€§èƒ½è¾ƒå·®<br>â€¢ ä½“éªŒä¸ä½³ | ç®€å•åµŒå…¥åœºæ™¯ |

**ç»“è®º**ï¼šå¯¹äºç±»ä¼¼å¾®åšã€æœ‹å‹åœˆçš„è§†é¢‘å±•ç¤ºéœ€æ±‚ï¼Œ`AVKit.VideoPlayer` æ˜¯æœ€ä½³é€‰æ‹©ã€‚

---

## æ•°æ®æ¨¡å‹è®¾è®¡

### Post æ¨¡å‹æ‰©å±•

#### 1. æ·»åŠ è§†é¢‘å­—æ®µ

```swift
@Model
final class Post {
    // ... åŸæœ‰å­—æ®µ ...
    
    /// è§†é¢‘ URLï¼ˆå¯é€‰ï¼‰
    /// å¦‚æœå¸–å­åŒ…å«è§†é¢‘ï¼Œåˆ™å­˜å‚¨è§†é¢‘æ–‡ä»¶åæˆ–å®Œæ•´ URL
    /// ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºæ²¡æœ‰è§†é¢‘
    var videoUrl: String
    
    /// åˆ¤æ–­å¸–å­æ˜¯å¦åŒ…å«è§†é¢‘
    var hasVideo: Bool {
        return !videoUrl.isEmpty
    }
}
```

#### 2. åˆå§‹åŒ–æ–¹æ³•æ›´æ–°

```swift
init(
    id: Int,
    avatar: String,
    vip: Bool,
    name: String,
    date: String,
    isFollowed: Bool,
    text: String,
    images: [String],
    commentCount: Int,
    likeCount: Int,
    isLiked: Bool,
    videoUrl: String = ""  // â† æ–°å¢å‚æ•°ï¼Œé»˜è®¤ä¸ºç©º
) {
    // ... èµ‹å€¼é€»è¾‘ ...
    self.videoUrl = videoUrl
}
```

#### 3. JSON è§£ææ›´æ–°

```swift
convenience init?(from json: [String: Any]) {
    // ... åŸæœ‰å­—æ®µè§£æ ...
    
    // video_url æ˜¯å¯é€‰å­—æ®µï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ç©ºå­—ç¬¦ä¸²
    let videoUrl = json["video_url"] as? String ?? ""
    
    self.init(
        // ... å…¶ä»–å‚æ•° ...
        videoUrl: videoUrl
    )
}
```

#### 4. JSON å¯¼å‡ºæ›´æ–°

```swift
func toJSON() -> [String: Any] {
    return [
        // ... åŸæœ‰å­—æ®µ ...
        "video_url": videoUrl  // â† æ–°å¢å¯¼å‡º
    ]
}
```

### JSON æ•°æ®æ ¼å¼

```json
{
    "list": [
        {
            "id": 3000,
            "avatar": "001Na93Ily8hobj985plqj60j60j63zr02.jpg",
            "vip": true,
            "name": "æ–°æµªå¨±ä¹",
            "date": "2026-01-26 12:59",
            "isFollowed": false,
            "text": "è§†é¢‘å†…å®¹æè¿°...",
            "images": [],
            "commentCount": 11,
            "likeCount": 62,
            "isLiked": false,
            "video_url": "20260126_QoTf39MiD.mp4"  â† æ–°å¢å­—æ®µ
        }
    ]
}
```

---

## è§†é¢‘æ’­æ”¾å™¨å®ç°

### 1. æ ¸å¿ƒç»„ä»¶ï¼šSimpleVideoPlayer

è¿™æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„è§†é¢‘æ’­æ”¾å™¨ï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤æ§åˆ¶æ ã€‚

```swift
import SwiftUI
import AVKit

struct SimpleVideoPlayer: View {
    let videoUrl: String
    @State private var player: AVPlayer?
    
    var body: some View {
        GeometryReader { geometry in
            ZStack {
                // é»‘è‰²èƒŒæ™¯
                Color.black
                
                if let player = player {
                    // AVKit çš„ VideoPlayer
                    VideoPlayer(player: player)
                        .onAppear {
                            setupPlayer(player)
                        }
                } else {
                    // åŠ è½½æŒ‡ç¤ºå™¨
                    ProgressView()
                        .progressViewStyle(CircularProgressViewStyle(tint: .white))
                        .scaleEffect(1.5)
                }
            }
            .frame(width: geometry.size.width, height: geometry.size.height)
            .cornerRadius(12)
            .onAppear {
                loadVideo()
            }
            .onDisappear {
                cleanupPlayer()
            }
        }
    }
    
    // åŠ è½½è§†é¢‘
    private func loadVideo() { /* ... */ }
    
    // è®¾ç½®æ’­æ”¾å™¨
    private func setupPlayer(_ player: AVPlayer) { /* ... */ }
    
    // æ¸…ç†æ’­æ”¾å™¨
    private func cleanupPlayer() { /* ... */ }
}
```

### 2. é«˜çº§ç»„ä»¶ï¼šPostVideoPlayer

è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„è§†é¢‘æ’­æ”¾å™¨ï¼ŒåŒ…å«è‡ªå®šä¹‰æ§åˆ¶å’ŒçŠ¶æ€ç®¡ç†ã€‚

#### æ ¸å¿ƒåŠŸèƒ½

1. **çŠ¶æ€ç®¡ç†**
```swift
@State private var player: AVPlayer?        // æ’­æ”¾å™¨å®ä¾‹
@State private var isPlaying = false        // æ’­æ”¾çŠ¶æ€
@State private var showControls = true      // æ§åˆ¶æ æ˜¾ç¤º
@State private var isLoading = true         // åŠ è½½çŠ¶æ€
@State private var loadError = false        // é”™è¯¯çŠ¶æ€
```

2. **è§†é¢‘åŠ è½½**
```swift
private func loadVideo() {
    // 1. æ„å»ºå®Œæ•´ URL
    let fullURL: URL?
    if videoUrl.hasPrefix("http://") || videoUrl.hasPrefix("https://") {
        fullURL = URL(string: videoUrl)
    } else {
        let baseURL = "https://weibo.com/tv/show/"
        fullURL = URL(string: baseURL + videoUrl)
    }
    
    // 2. åˆ›å»ºæ’­æ”¾å™¨
    let playerItem = AVPlayerItem(url: url)
    let newPlayer = AVPlayer(playerItem: playerItem)
    
    // 3. ç›‘å¬çŠ¶æ€
    playerItem.publisher(for: \.status)
        .sink { status in
            switch status {
            case .readyToPlay:
                // å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹æ’­æ”¾
            case .failed:
                // åŠ è½½å¤±è´¥
            case .unknown:
                // åŠ è½½ä¸­
            }
        }
}
```

3. **å¾ªç¯æ’­æ”¾**
```swift
NotificationCenter.default.addObserver(
    forName: .AVPlayerItemDidPlayToEndTime,
    object: player.currentItem,
    queue: .main
) { _ in
    player.seek(to: .zero)  // å›åˆ°å¼€å§‹
    player.play()           // ç»§ç»­æ’­æ”¾
}
```

4. **è‡ªå®šä¹‰æ§åˆ¶**
```swift
.overlay {
    if showControls && !isLoading {
        Button(action: {
            if isPlaying {
                player.pause()
            } else {
                player.play()
            }
            isPlaying.toggle()
        }) {
            Image(systemName: isPlaying ? "pause.circle.fill" : "play.circle.fill")
                .font(.system(size: 50))
                .foregroundColor(.white.opacity(0.8))
        }
    }
}
```

5. **é”™è¯¯å¤„ç†**
```swift
if loadError {
    VStack(spacing: 12) {
        Image(systemName: "exclamationmark.triangle")
            .font(.system(size: 40))
            .foregroundColor(.white.opacity(0.7))
        Text("è§†é¢‘åŠ è½½å¤±è´¥")
            .font(.subheadline)
            .foregroundColor(.white.opacity(0.7))
    }
}
```

---

## UI é›†æˆ

### PostCellView é›†æˆé€»è¾‘

#### 1. åª’ä½“å†…å®¹åŒºåŸŸæ”¹é€ 

**æ”¹é€ å‰**ï¼ˆä»…æ”¯æŒå›¾ç‰‡ï¼‰ï¼š
```swift
// å›¾ç‰‡ç½‘æ ¼
if !post.images.isEmpty {
    PostImageCell(images: post.images, width: imageWidth)
}
```

**æ”¹é€ å**ï¼ˆæ”¯æŒè§†é¢‘å’Œå›¾ç‰‡ï¼‰ï¼š
```swift
// è§†é¢‘æ’­æ”¾å™¨ï¼ˆä¼˜å…ˆæ˜¾ç¤ºè§†é¢‘ï¼‰
if post.hasVideo {
    let screenWidth = UIScreen.main.bounds.width
    let videoWidth = screenWidth - 32
    let videoHeight = videoWidth * 9 / 16  // 16:9 æ¯”ä¾‹
    
    SimpleVideoPlayer(videoUrl: post.videoUrl)
        .frame(width: videoWidth, height: videoHeight)
        .cornerRadius(12)
}
// å›¾ç‰‡ç½‘æ ¼ï¼ˆå¦‚æœæ²¡æœ‰è§†é¢‘æ‰æ˜¾ç¤ºå›¾ç‰‡ï¼‰
else if !post.images.isEmpty {
    PostImageCell(images: post.images, width: imageWidth)
}
```

#### 2. è§†é¢‘æ¯”ä¾‹è¯´æ˜

- **16:9 æ ‡å‡†æ¯”ä¾‹**ï¼šæœ€å¸¸è§çš„è§†é¢‘æ¯”ä¾‹ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯
- **è®¡ç®—å…¬å¼**ï¼š`videoHeight = videoWidth * 9 / 16`
- **ç¤ºä¾‹**ï¼šå±å¹•å®½åº¦ 375pt â†’ è§†é¢‘å®½åº¦ 343pt â†’ è§†é¢‘é«˜åº¦ 193pt

#### 3. å¸ƒå±€å±‚æ¬¡

```
PostCellView
â”œâ”€ VStack (ä¸»å®¹å™¨)
â”‚  â”œâ”€ HStack (ç”¨æˆ·ä¿¡æ¯)
â”‚  â”œâ”€ Text (æ–‡æœ¬å†…å®¹)
â”‚  â”œâ”€ åª’ä½“å†…å®¹åŒº â† è¿™é‡Œé›†æˆè§†é¢‘
â”‚  â”‚  â”œâ”€ SimpleVideoPlayer (å¦‚æœæœ‰è§†é¢‘)
â”‚  â”‚  â””â”€ PostImageCell (å¦‚æœæ²¡æœ‰è§†é¢‘ä½†æœ‰å›¾ç‰‡)
â”‚  â””â”€ HStack (äº’åŠ¨å·¥å…·æ )
```

---

## æºç å®ç°é€»è¾‘

### å®Œæ•´å®ç°æµç¨‹

#### ç¬¬ä¸€æ­¥ï¼šæ•°æ®æ¨¡å‹å‡†å¤‡

```swift
// æ–‡ä»¶ï¼šModels/Post.swift

@Model
final class Post {
    // 1. æ·»åŠ è§†é¢‘å­—æ®µ
    var videoUrl: String
    
    // 2. æ·»åŠ ä¾¿æ·å±æ€§
    var hasVideo: Bool {
        return !videoUrl.isEmpty
    }
    
    // 3. æ›´æ–°åˆå§‹åŒ–æ–¹æ³•
    init(..., videoUrl: String = "") {
        // ...
        self.videoUrl = videoUrl
    }
    
    // 4. æ›´æ–° JSON è§£æ
    convenience init?(from json: [String: Any]) {
        let videoUrl = json["video_url"] as? String ?? ""
        self.init(..., videoUrl: videoUrl)
    }
    
    // 5. æ›´æ–° JSON å¯¼å‡º
    func toJSON() -> [String: Any] {
        return [
            // ...
            "video_url": videoUrl
        ]
    }
}
```

#### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºè§†é¢‘æ’­æ”¾å™¨

```swift
// æ–‡ä»¶ï¼šViews/PostVideoPlayer.swift

import SwiftUI
import AVKit
import Combine

// ç®€åŒ–ç‰ˆæ’­æ”¾å™¨
struct SimpleVideoPlayer: View {
    let videoUrl: String
    @State private var player: AVPlayer?
    
    var body: some View {
        GeometryReader { geometry in
            ZStack {
                Color.black
                
                if let player = player {
                    VideoPlayer(player: player)
                        .onAppear {
                            // è®¾ç½®å¾ªç¯æ’­æ”¾
                            NotificationCenter.default.addObserver(
                                forName: .AVPlayerItemDidPlayToEndTime,
                                object: player.currentItem,
                                queue: .main
                            ) { _ in
                                player.seek(to: .zero)
                                player.play()
                            }
                            // è‡ªåŠ¨æ’­æ”¾
                            player.play()
                        }
                } else {
                    ProgressView()
                        .progressViewStyle(CircularProgressViewStyle(tint: .white))
                        .scaleEffect(1.5)
                }
            }
            .frame(width: geometry.size.width, height: geometry.size.height)
            .cornerRadius(12)
            .onAppear {
                loadVideo()
            }
            .onDisappear {
                player?.pause()
                player = nil
            }
        }
    }
    
    private func loadVideo() {
        // æ„å»ºå®Œæ•´ URL
        let fullURL: URL?
        if videoUrl.hasPrefix("http://") || videoUrl.hasPrefix("https://") {
            fullURL = URL(string: videoUrl)
        } else {
            let baseURL = "https://weibo.com/tv/show/"
            fullURL = URL(string: baseURL + videoUrl)
        }
        
        guard let url = fullURL else {
            print("âŒ æ— æ•ˆçš„è§†é¢‘ URL: \(videoUrl)")
            return
        }
        
        print("ğŸ“¹ åŠ è½½è§†é¢‘: \(url.absoluteString)")
        player = AVPlayer(url: url)
    }
}

// é«˜çº§ç‰ˆæ’­æ”¾å™¨ï¼ˆå¸¦è‡ªå®šä¹‰æ§åˆ¶ï¼‰
struct PostVideoPlayer: View {
    let videoUrl: String
    @State private var player: AVPlayer?
    @State private var isPlaying = false
    @State private var showControls = true
    @State private var isLoading = true
    @State private var loadError = false
    @State private var cancellables = Set<AnyCancellable>()
    
    var body: some View {
        GeometryReader { geometry in
            ZStack {
                Color.black
                
                if loadError {
                    // é”™è¯¯æç¤º
                    VStack(spacing: 12) {
                        Image(systemName: "exclamationmark.triangle")
                            .font(.system(size: 40))
                            .foregroundColor(.white.opacity(0.7))
                        Text("è§†é¢‘åŠ è½½å¤±è´¥")
                            .font(.subheadline)
                            .foregroundColor(.white.opacity(0.7))
                    }
                } else if let player = player {
                    // è§†é¢‘æ’­æ”¾å™¨
                    VideoPlayer(player: player)
                        .overlay {
                            // åŠ è½½æŒ‡ç¤ºå™¨
                            if isLoading {
                                ProgressView()
                                    .progressViewStyle(CircularProgressViewStyle(tint: .white))
                                    .scaleEffect(1.5)
                            }
                        }
                        .overlay {
                            // è‡ªå®šä¹‰æ’­æ”¾/æš‚åœæŒ‰é’®
                            if showControls && !isLoading {
                                Button(action: {
                                    if isPlaying {
                                        player.pause()
                                    } else {
                                        player.play()
                                    }
                                    isPlaying.toggle()
                                }) {
                                    Image(systemName: isPlaying ? "pause.circle.fill" : "play.circle.fill")
                                        .font(.system(size: 50))
                                        .foregroundColor(.white.opacity(0.8))
                                        .shadow(radius: 10)
                                }
                            }
                        }
                        .onTapGesture {
                            // ç‚¹å‡»åˆ‡æ¢æ§åˆ¶æ æ˜¾ç¤º
                            withAnimation {
                                showControls.toggle()
                            }
                        }
                } else {
                    // åˆå§‹åŠ è½½
                    ProgressView()
                        .progressViewStyle(CircularProgressViewStyle(tint: .white))
                        .scaleEffect(1.5)
                }
            }
            .frame(width: geometry.size.width, height: geometry.size.height)
            .cornerRadius(12)
            .onAppear {
                loadVideo()
            }
            .onDisappear {
                player?.pause()
                player = nil
            }
        }
    }
    
    private func loadVideo() {
        // URL å¤„ç†
        let fullURL: URL?
        if videoUrl.hasPrefix("http://") || videoUrl.hasPrefix("https://") {
            fullURL = URL(string: videoUrl)
        } else {
            let baseURL = "https://weibo.com/tv/show/"
            fullURL = URL(string: baseURL + videoUrl)
        }
        
        guard let url = fullURL else {
            print("âŒ æ— æ•ˆçš„è§†é¢‘ URL: \(videoUrl)")
            loadError = true
            isLoading = false
            return
        }
        
        print("ğŸ“¹ åŠ è½½è§†é¢‘: \(url.absoluteString)")
        
        // åˆ›å»ºæ’­æ”¾å™¨
        let playerItem = AVPlayerItem(url: url)
        let newPlayer = AVPlayer(playerItem: playerItem)
        
        // ç›‘å¬æ’­æ”¾å™¨çŠ¶æ€
        playerItem.publisher(for: \.status)
            .sink { status in
                DispatchQueue.main.async {
                    switch status {
                    case .readyToPlay:
                        print("âœ… è§†é¢‘å‡†å¤‡å°±ç»ª")
                        isLoading = false
                        loadError = false
                        newPlayer.play()
                        isPlaying = true
                        // 3ç§’åéšè—æ§åˆ¶æ 
                        DispatchQueue.main.asyncAfter(deadline: .now() + 3) {
                            withAnimation {
                                showControls = false
                            }
                        }
                    case .failed:
                        print("âŒ è§†é¢‘åŠ è½½å¤±è´¥")
                        isLoading = false
                        loadError = true
                    case .unknown:
                        print("â³ è§†é¢‘åŠ è½½ä¸­...")
                    @unknown default:
                        break
                    }
                }
            }
            .store(in: &cancellables)
        
        self.player = newPlayer
    }
}
```

#### ç¬¬ä¸‰æ­¥ï¼šé›†æˆåˆ° PostCellView

```swift
// æ–‡ä»¶ï¼šViews/PostCellView.swift

struct PostCellView: View {
    @Bindable var post: Post
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            // ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
            // ...
            
            // æ–‡æœ¬å†…å®¹
            Text(post.text)
                .font(.body)
                .lineLimit(nil)
            
            // åª’ä½“å†…å®¹åŒºåŸŸ â† æ ¸å¿ƒæ”¹åŠ¨
            if post.hasVideo {
                // æ˜¾ç¤ºè§†é¢‘
                let screenWidth = UIScreen.main.bounds.width
                let videoWidth = screenWidth - 32
                let videoHeight = videoWidth * 9 / 16
                
                SimpleVideoPlayer(videoUrl: post.videoUrl)
                    .frame(width: videoWidth, height: videoHeight)
                    .cornerRadius(12)
            }
            else if !post.images.isEmpty {
                // æ˜¾ç¤ºå›¾ç‰‡
                let screenWidth = UIScreen.main.bounds.width
                let imageWidth = screenWidth - 32
                PostImageCell(images: post.images, width: imageWidth)
                    .frame(height: calculateImageHeight(images: post.images, width: imageWidth))
            }
            
            // äº’åŠ¨å·¥å…·æ 
            // ...
        }
    }
}
```

#### ç¬¬å››æ­¥ï¼šæ›´æ–°æ•°æ®åŠ è½½

```swift
// æ–‡ä»¶ï¼šViews/HomeView.swift

struct HomeView: View {
    @MainActor
    private func loadInitialData() async {
        // åŠ è½½æ¨èæ•°æ® - ä½¿ç”¨æ–°çš„ JSON æ–‡ä»¶
        let recommendLoaded = JSONService.loadPostsFromJSON(
            fileName: "PostListData_recommend_2.json",
            modelContext: modelContext
        )
        
        // åŠ è½½çƒ­é—¨æ•°æ® - ä½¿ç”¨æ–°çš„ JSON æ–‡ä»¶
        let hotLoaded = JSONService.loadPostsFromJSON(
            fileName: "PostListData_hot_2.json",
            modelContext: modelContext
        )
    }
}
```

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåŸºæœ¬ä½¿ç”¨

```swift
// åˆ›å»ºå¸¦è§†é¢‘çš„å¸–å­
let post = Post(
    id: 3000,
    avatar: "avatar.jpg",
    vip: true,
    name: "æ–°æµªå¨±ä¹",
    date: "2026-01-26 12:59",
    isFollowed: false,
    text: "ç²¾å½©è§†é¢‘å†…å®¹...",
    images: [],
    commentCount: 11,
    likeCount: 62,
    isLiked: false,
    videoUrl: "20260126_QoTf39MiD.mp4"  // â† è§†é¢‘æ–‡ä»¶å
)

// åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤º
PostCellView(post: post)
```

### ç¤ºä¾‹ 2ï¼šå®Œæ•´ URL

```swift
let post = Post(
    // ...
    videoUrl: "https://example.com/videos/sample.mp4"  // â† å®Œæ•´ URL
)
```

### ç¤ºä¾‹ 3ï¼šæ··åˆå†…å®¹åˆ—è¡¨

```json
{
    "list": [
        {
            "id": 3000,
            "text": "è¿™æ˜¯ä¸€ä¸ªè§†é¢‘å¸–å­",
            "images": [],
            "video_url": "video1.mp4"
        },
        {
            "id": 3001,
            "text": "è¿™æ˜¯ä¸€ä¸ªå›¾ç‰‡å¸–å­",
            "images": ["img1.jpg", "img2.jpg"],
            "video_url": ""
        },
        {
            "id": 3002,
            "text": "è¿™æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬å¸–å­",
            "images": [],
            "video_url": ""
        }
    ]
}
```

---

## å¸¸è§é—®é¢˜

### Q1: è§†é¢‘ä¸æ’­æ”¾æ€ä¹ˆåŠï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
1. URL æ ¼å¼é”™è¯¯
2. ç½‘ç»œæƒé™æœªé…ç½®
3. è§†é¢‘æ ¼å¼ä¸æ”¯æŒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```swift
// 1. æ£€æŸ¥ URL
print("ğŸ“¹ è§†é¢‘ URL: \(videoUrl)")

// 2. é…ç½® Info.plist
// æ·»åŠ  App Transport Security Settings
// - Allow Arbitrary Loads: YES

// 3. æ£€æŸ¥è§†é¢‘æ ¼å¼
// AVPlayer æ”¯æŒï¼šMP4, MOV, M4V ç­‰
```

### Q2: å¦‚ä½•ä¼˜åŒ–è§†é¢‘åŠ è½½æ€§èƒ½ï¼Ÿ

**ä¼˜åŒ–ç­–ç•¥**ï¼š
```swift
// 1. é¢„åŠ è½½
player.automaticallyWaitsToMinimizeStalling = true

// 2. ç¼“å­˜ç­–ç•¥
let asset = AVURLAsset(url: videoURL)
asset.resourceLoader.setDelegate(self, queue: .main)

// 3. æ‡’åŠ è½½
// åªåœ¨è§†é¢‘è¿›å…¥å¯è§åŒºåŸŸæ—¶åŠ è½½
```

### Q3: å¦‚ä½•å®ç°é™éŸ³æ’­æ”¾ï¼Ÿ

```swift
player.isMuted = true
```

### Q4: å¦‚ä½•ç›‘å¬æ’­æ”¾è¿›åº¦ï¼Ÿ

```swift
let interval = CMTime(seconds: 0.5, preferredTimescale: CMTimeScale(NSEC_PER_SEC))
player.addPeriodicTimeObserver(forInterval: interval, queue: .main) { time in
    let currentTime = CMTimeGetSeconds(time)
    print("å½“å‰æ’­æ”¾æ—¶é—´: \(currentTime)")
}
```

### Q5: è§†é¢‘å’Œå›¾ç‰‡èƒ½åŒæ—¶æ˜¾ç¤ºå—ï¼Ÿ

**å½“å‰è®¾è®¡**ï¼šè§†é¢‘ä¼˜å…ˆï¼Œä¸åŒæ—¶æ˜¾ç¤º
```swift
if post.hasVideo {
    // æ˜¾ç¤ºè§†é¢‘
} else if !post.images.isEmpty {
    // æ˜¾ç¤ºå›¾ç‰‡
}
```

**å¦‚éœ€åŒæ—¶æ˜¾ç¤º**ï¼š
```swift
// æ˜¾ç¤ºè§†é¢‘
if post.hasVideo {
    SimpleVideoPlayer(videoUrl: post.videoUrl)
}

// æ˜¾ç¤ºå›¾ç‰‡
if !post.images.isEmpty {
    PostImageCell(images: post.images, width: imageWidth)
}
```

### Q6: å¦‚ä½•å¤„ç†è§†é¢‘åŠ è½½å¤±è´¥ï¼Ÿ

```swift
// PostVideoPlayer å·²å†…ç½®é”™è¯¯å¤„ç†
if loadError {
    VStack {
        Image(systemName: "exclamationmark.triangle")
        Text("è§†é¢‘åŠ è½½å¤±è´¥")
        Button("é‡è¯•") {
            loadVideo()
        }
    }
}
```

### Q7: å¦‚ä½•å®ç°å…¨å±æ’­æ”¾ï¼Ÿ

```swift
// ä½¿ç”¨ AVPlayerViewController
import AVKit

struct FullScreenVideoPlayer: View {
    let videoUrl: String
    @State private var showPlayer = false
    
    var body: some View {
        Button("å…¨å±æ’­æ”¾") {
            showPlayer = true
        }
        .fullScreenCover(isPresented: $showPlayer) {
            VideoPlayerViewController(videoUrl: videoUrl)
        }
    }
}

struct VideoPlayerViewController: UIViewControllerRepresentable {
    let videoUrl: String
    
    func makeUIViewController(context: Context) -> AVPlayerViewController {
        let controller = AVPlayerViewController()
        let player = AVPlayer(url: URL(string: videoUrl)!)
        controller.player = player
        player.play()
        return controller
    }
    
    func updateUIViewController(_ uiViewController: AVPlayerViewController, context: Context) {}
}
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ•°æ®æ¨¡å‹**ï¼šæ·»åŠ  `videoUrl` å­—æ®µï¼Œä¿æŒå‘åå…¼å®¹
2. **è§†é¢‘æ’­æ”¾å™¨**ï¼šä½¿ç”¨ `AVKit.VideoPlayer`ï¼Œç®€å•é«˜æ•ˆ
3. **UI é›†æˆ**ï¼šè§†é¢‘ä¼˜å…ˆæ˜¾ç¤ºï¼Œå›¾ç‰‡ä½œä¸ºå¤‡é€‰
4. **ç”¨æˆ·ä½“éªŒ**ï¼šè‡ªåŠ¨æ’­æ”¾ã€å¾ªç¯æ’­æ”¾ã€åŠ è½½æç¤º

### æœ€ä½³å®è·µ

- âœ… ä½¿ç”¨ 16:9 æ ‡å‡†è§†é¢‘æ¯”ä¾‹
- âœ… æä¾›åŠ è½½çŠ¶æ€åé¦ˆ
- âœ… å®ç°é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… åœ¨è§†å›¾æ¶ˆå¤±æ—¶æ¸…ç†æ’­æ”¾å™¨
- âœ… æ”¯æŒå®Œæ•´ URL å’Œæ–‡ä»¶åä¸¤ç§æ ¼å¼

### æ‰©å±•æ–¹å‘

- ğŸ”„ æ·»åŠ æ’­æ”¾è¿›åº¦æ¡
- ğŸ”Š éŸ³é‡æ§åˆ¶
- ğŸ“± å…¨å±æ’­æ”¾æ”¯æŒ
- ğŸ’¾ è§†é¢‘ç¼“å­˜æœºåˆ¶
- ğŸ“Š æ’­æ”¾ç»Ÿè®¡åˆ†æ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2026-01-27  
**ä½œè€…**ï¼šAI Assistant  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šiOS 17.0+, SwiftUI 5.0+

