# æœ¬åœ°å¸–å­å‘å¸ƒä¸åª’ä½“ä¸Šä¼ æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®éœ€æ±‚

1. **æ·»åŠ å¸–å­åŠŸèƒ½**ï¼šç”¨æˆ·å¯ä»¥åˆ›å»ºæ–°å¸–å­
2. **ä¸Šä¼ å›¾ç‰‡/è§†é¢‘**ï¼šæ”¯æŒæœ¬åœ°é€‰æ‹©å›¾ç‰‡æˆ–è§†é¢‘
3. **æœ¬åœ°é¢„è§ˆ**ï¼šä¸å‘é€åˆ°ç½‘ç»œï¼Œä»…åœ¨æœ¬åœ°æŸ¥çœ‹
4. **æ•°æ®ç®¡ç†**ï¼šåˆç†çš„JSONæ–‡ä»¶ç»„ç»‡æ–¹å¼
5. **æ•°æ®éš”ç¦»**ï¼šç½‘ç»œæ•°æ®ä¸æœ¬åœ°æ•°æ®çš„äº¤äº’ç­–ç•¥

---

## ğŸ¯ æ ¸å¿ƒæ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆä¸€ï¼šæ¨èæ–¹æ¡ˆï¼ˆæ•°æ®æºåˆ†ç¦»ï¼‰

#### æ¶æ„è®¾è®¡

```
æ•°æ®å±‚çº§ï¼š
â”œâ”€â”€ ç½‘ç»œæ•°æ®ï¼ˆåªè¯»ï¼‰
â”‚   â”œâ”€â”€ PostListData_recommend_1.json (ID: 1000-1999)
â”‚   â”œâ”€â”€ PostListData_hot_1.json (ID: 2000-2999)
â”‚   â””â”€â”€ PostListData_video_1.json (ID: 3000-3999)
â”‚
â”œâ”€â”€ æœ¬åœ°ç”¨æˆ·æ•°æ®ï¼ˆå¯è¯»å†™ï¼‰
â”‚   â”œâ”€â”€ UserPosts.json (ID: 10000+)
â”‚   â””â”€â”€ å­˜å‚¨ä½ç½®ï¼šDocuments ç›®å½•
â”‚
â””â”€â”€ SwiftData æ•°æ®åº“ï¼ˆç»Ÿä¸€å­˜å‚¨ï¼‰
    â””â”€â”€ åˆå¹¶å±•ç¤ºæ‰€æœ‰æ•°æ®
```

#### ä¼˜åŠ¿
- âœ… **æ•°æ®éš”ç¦»æ¸…æ™°**ï¼šç½‘ç»œæ•°æ®å’Œç”¨æˆ·æ•°æ®å®Œå…¨åˆ†ç¦»
- âœ… **æ˜“äºç®¡ç†**ï¼šç”¨æˆ·æ•°æ®ç‹¬ç«‹æ–‡ä»¶ï¼Œä¾¿äºå¤‡ä»½å’Œæ¸…ç†
- âœ… **ID ä¸å†²çª**ï¼šä½¿ç”¨ä¸åŒçš„ ID èŒƒå›´
- âœ… **å¯æ‰©å±•æ€§å¼º**ï¼šæœªæ¥å¯ä»¥æ·»åŠ äº‘åŒæ­¥åŠŸèƒ½

---

## ğŸ“± åŠŸèƒ½å®ç°è¯¦è§£

### 1. å›¾ç‰‡/è§†é¢‘é€‰æ‹©ä¸å­˜å‚¨

#### 1.1 ä½¿ç”¨ PhotosPicker é€‰æ‹©åª’ä½“

```swift
import PhotosUI

struct AddPostView: View {
    @State private var selectedPhotos: [PhotosPickerItem] = []
    @State private var selectedVideoItem: PhotosPickerItem?
    @State private var localImagePaths: [String] = []
    @State private var localVideoPath: String = ""
    
    var body: some View {
        Form {
            // å›¾ç‰‡é€‰æ‹©å™¨ï¼ˆå¤šé€‰ï¼‰
            Section("é€‰æ‹©å›¾ç‰‡") {
                PhotosPicker(
                    selection: $selectedPhotos,
                    maxSelectionCount: 9,
                    matching: .images
                ) {
                    Label("é€‰æ‹©å›¾ç‰‡", systemImage: "photo.on.rectangle")
                }
                
                // æ˜¾ç¤ºå·²é€‰å›¾ç‰‡
                if !localImagePaths.isEmpty {
                    ScrollView(.horizontal) {
                        HStack {
                            ForEach(localImagePaths, id: \.self) { path in
                                AsyncImage(url: URL(fileURLWithPath: path)) { image in
                                    image.resizable()
                                        .scaledToFill()
                                        .frame(width: 80, height: 80)
                                        .clipShape(RoundedRectangle(cornerRadius: 8))
                                } placeholder: {
                                    ProgressView()
                                }
                            }
                        }
                    }
                }
            }
            
            // è§†é¢‘é€‰æ‹©å™¨ï¼ˆå•é€‰ï¼‰
            Section("é€‰æ‹©è§†é¢‘") {
                PhotosPicker(
                    selection: $selectedVideoItem,
                    matching: .videos
                ) {
                    Label("é€‰æ‹©è§†é¢‘", systemImage: "video")
                }
                
                if !localVideoPath.isEmpty {
                    Text("å·²é€‰æ‹©è§†é¢‘")
                        .foregroundColor(.green)
                }
            }
        }
        .onChange(of: selectedPhotos) { _, newItems in
            Task {
                await loadPhotos(from: newItems)
            }
        }
        .onChange(of: selectedVideoItem) { _, newItem in
            Task {
                await loadVideo(from: newItem)
            }
        }
    }
    
    // åŠ è½½å›¾ç‰‡
    private func loadPhotos(from items: [PhotosPickerItem]) async {
        localImagePaths.removeAll()
        
        for item in items {
            if let data = try? await item.loadTransferable(type: Data.self) {
                let path = saveMediaToLocal(data: data, type: .image)
                localImagePaths.append(path)
            }
        }
    }
    
    // åŠ è½½è§†é¢‘
    private func loadVideo(from item: PhotosPickerItem?) async {
        guard let item = item else { return }
        
        if let data = try? await item.loadTransferable(type: Data.self) {
            localVideoPath = saveMediaToLocal(data: data, type: .video)
        }
    }
}
```

#### 1.2 åª’ä½“æ–‡ä»¶æœ¬åœ°å­˜å‚¨

```swift
enum MediaType {
    case image
    case video
}

class MediaManager {
    static let shared = MediaManager()
    
    // è·å–åª’ä½“å­˜å‚¨ç›®å½•
    private var mediaDirectory: URL {
        let documentsURL = FileManager.default.urls(
            for: .documentDirectory,
            in: .userDomainMask
        ).first!
        
        let mediaURL = documentsURL.appendingPathComponent("UserMedia")
        
        // åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if !FileManager.default.fileExists(atPath: mediaURL.path) {
            try? FileManager.default.createDirectory(
                at: mediaURL,
                withIntermediateDirectories: true
            )
        }
        
        return mediaURL
    }
    
    // ä¿å­˜åª’ä½“æ–‡ä»¶
    func saveMedia(data: Data, type: MediaType) -> String {
        let timestamp = Int(Date().timeIntervalSince1970)
        let uuid = UUID().uuidString.prefix(8)
        
        let fileName: String
        switch type {
        case .image:
            fileName = "IMG_\(timestamp)_\(uuid).jpg"
        case .video:
            fileName = "VID_\(timestamp)_\(uuid).mp4"
        }
        
        let fileURL = mediaDirectory.appendingPathComponent(fileName)
        
        do {
            try data.write(to: fileURL)
            return fileURL.path
        } catch {
            print("âŒ ä¿å­˜åª’ä½“æ–‡ä»¶å¤±è´¥: \(error)")
            return ""
        }
    }
    
    // åˆ é™¤åª’ä½“æ–‡ä»¶
    func deleteMedia(at path: String) {
        let fileURL = URL(fileURLWithPath: path)
        try? FileManager.default.removeItem(at: fileURL)
    }
    
    // è·å–åª’ä½“æ–‡ä»¶å¤§å°
    func getMediaSize(at path: String) -> Int64 {
        let fileURL = URL(fileURLWithPath: path)
        let attributes = try? FileManager.default.attributesOfItem(atPath: fileURL.path)
        return attributes?[.size] as? Int64 ?? 0
    }
}
```

#### 1.3 å­˜å‚¨ç»“æ„

```
Documents/
â”œâ”€â”€ UserMedia/                    # ç”¨æˆ·åª’ä½“æ–‡ä»¶
â”‚   â”œâ”€â”€ IMG_1738123456_a1b2c3d4.jpg
â”‚   â”œâ”€â”€ IMG_1738123457_e5f6g7h8.jpg
â”‚   â””â”€â”€ VID_1738123458_i9j0k1l2.mp4
â”‚
â”œâ”€â”€ UserPosts.json               # ç”¨æˆ·å¸–å­æ•°æ®
â””â”€â”€ default.store                # SwiftData æ•°æ®åº“
```

---

### 2. JSON æ–‡ä»¶ç®¡ç†æ–¹æ¡ˆ

#### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| **æ–¹æ¡ˆAï¼šå•æ–‡ä»¶è¿½åŠ ** | ç®€å•ç›´æ¥ | æ–‡ä»¶è¿‡å¤§ã€éš¾ä»¥åˆ†ç±» | â­â­ |
| **æ–¹æ¡ˆBï¼šç‹¬ç«‹ç”¨æˆ·æ–‡ä»¶** | éš”ç¦»æ¸…æ™°ã€æ˜“ç®¡ç† | éœ€è¦åˆå¹¶æŸ¥è¯¢ | â­â­â­â­â­ |
| **æ–¹æ¡ˆCï¼šæŒ‰ç±»å‹åˆ†æ–‡ä»¶** | åˆ†ç±»æ¸…æ™° | æ–‡ä»¶è¾ƒå¤š | â­â­â­â­ |

#### æ¨èï¼šæ–¹æ¡ˆB - ç‹¬ç«‹ç”¨æˆ·æ–‡ä»¶

```swift
class UserPostManager {
    static let shared = UserPostManager()
    
    private let userPostsFileName = "UserPosts.json"
    private let userPostIDStart = 10000  // ç”¨æˆ·å¸–å­ ID ä» 10000 å¼€å§‹
    
    // è·å–ç”¨æˆ·å¸–å­æ–‡ä»¶è·¯å¾„
    private var userPostsFileURL: URL {
        let documentsURL = FileManager.default.urls(
            for: .documentDirectory,
            in: .userDomainMask
        ).first!
        return documentsURL.appendingPathComponent(userPostsFileName)
    }
    
    // ä¿å­˜ç”¨æˆ·å¸–å­åˆ° JSON
    func saveUserPost(_ post: Post, modelContext: ModelContext) -> Bool {
        // 1. è¯»å–ç°æœ‰ç”¨æˆ·å¸–å­
        var userPosts = loadUserPosts()
        
        // 2. æ·»åŠ æ–°å¸–å­
        userPosts.append(post)
        
        // 3. è½¬æ¢ä¸º JSON
        let jsonArray = userPosts.map { $0.toJSON() }
        let json: [String: Any] = [
            "list": jsonArray,
            "source": "user_created",
            "version": "1.0",
            "lastModified": ISO8601DateFormatter().string(from: Date())
        ]
        
        // 4. å†™å…¥æ–‡ä»¶
        do {
            let jsonData = try JSONSerialization.data(
                withJSONObject: json,
                options: [.prettyPrinted, .sortedKeys]
            )
            try jsonData.write(to: userPostsFileURL)
            print("âœ… ç”¨æˆ·å¸–å­å·²ä¿å­˜åˆ°: \(userPostsFileURL.path)")
            return true
        } catch {
            print("âŒ ä¿å­˜ç”¨æˆ·å¸–å­å¤±è´¥: \(error)")
            return false
        }
    }
    
    // åŠ è½½ç”¨æˆ·å¸–å­
    func loadUserPosts() -> [Post] {
        guard FileManager.default.fileExists(atPath: userPostsFileURL.path) else {
            return []
        }
        
        do {
            let data = try Data(contentsOf: userPostsFileURL)
            let json = try JSONSerialization.jsonObject(with: data) as? [String: Any]
            let list = json?["list"] as? [[String: Any]] ?? []
            
            return list.compactMap { Post(from: $0) }
        } catch {
            print("âŒ åŠ è½½ç”¨æˆ·å¸–å­å¤±è´¥: \(error)")
            return []
        }
    }
    
    // ç”Ÿæˆæ–°çš„ç”¨æˆ·å¸–å­ ID
    func generateNewUserPostID(modelContext: ModelContext) -> Int {
        let descriptor = FetchDescriptor<Post>(
            predicate: #Predicate<Post> { post in
                post.id >= 10000
            },
            sortBy: [SortDescriptor(\.id, order: .reverse)]
        )
        
        let existingPosts = try? modelContext.fetch(descriptor)
        let maxId = existingPosts?.first?.id ?? (userPostIDStart - 1)
        return maxId + 1
    }
}
```

#### JSON æ–‡ä»¶ç»“æ„

```json
{
  "list": [
    {
      "id": 10001,
      "avatar": "local://UserMedia/avatar_default.jpg",
      "vip": false,
      "name": "æœ¬åœ°ç”¨æˆ·",
      "date": "2026-01-29 15:30",
      "isFollowed": false,
      "text": "è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€æ¡æœ¬åœ°å¸–å­",
      "images": [
        "local://UserMedia/IMG_1738123456_a1b2c3d4.jpg",
        "local://UserMedia/IMG_1738123457_e5f6g7h8.jpg"
      ],
      "commentCount": 0,
      "likeCount": 0,
      "isLiked": false,
      "video_url": "",
      "isLocal": true
    }
  ],
  "source": "user_created",
  "version": "1.0",
  "lastModified": "2026-01-29T15:30:00Z"
}
```

---

### 3. æ•°æ®éš”ç¦»ä¸äº¤äº’ç­–ç•¥

#### 3.1 æ•°æ®æ ‡è¯†æ–¹æ¡ˆ

```swift
// æ‰©å±• Post æ¨¡å‹
extension Post {
    // åˆ¤æ–­æ˜¯å¦ä¸ºæœ¬åœ°åˆ›å»ºçš„å¸–å­
    var isLocalPost: Bool {
        return id >= 10000
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºç½‘ç»œæ•°æ®
    var isNetworkPost: Bool {
        return id < 10000
    }
    
    // è·å–æ•°æ®æºç±»å‹
    var sourceType: PostSourceType {
        switch id {
        case 1000..<2000: return .recommendNetwork
        case 2000..<3000: return .hotNetwork
        case 3000..<4000: return .videoNetwork
        case 10000...: return .userLocal
        default: return .unknown
        }
    }
}

enum PostSourceType {
    case recommendNetwork  // ç½‘ç»œæ¨è
    case hotNetwork        // ç½‘ç»œçƒ­é—¨
    case videoNetwork      // ç½‘ç»œè§†é¢‘
    case userLocal         // ç”¨æˆ·æœ¬åœ°
    case unknown
    
    var displayName: String {
        switch self {
        case .recommendNetwork: return "æ¨è"
        case .hotNetwork: return "çƒ­é—¨"
        case .videoNetwork: return "è§†é¢‘"
        case .userLocal: return "æˆ‘çš„"
        case .unknown: return "æœªçŸ¥"
        }
    }
}
```

#### 3.2 æ•°æ®åŠ è½½ç­–ç•¥

```swift
class DataLoadManager {
    static let shared = DataLoadManager()
    
    // åˆå§‹åŒ–æ•°æ®
    func initializeData(modelContext: ModelContext) {
        // 1. åŠ è½½ç½‘ç»œæ•°æ®ï¼ˆBundle ä¸­çš„ JSONï¼‰
        loadNetworkData(modelContext: modelContext)
        
        // 2. åŠ è½½ç”¨æˆ·æœ¬åœ°æ•°æ®ï¼ˆDocuments ä¸­çš„ JSONï¼‰
        loadUserLocalData(modelContext: modelContext)
    }
    
    // åŠ è½½ç½‘ç»œæ•°æ®
    private func loadNetworkData(modelContext: ModelContext) {
        let networkFiles = [
            "PostListData_recommend_1.json",
            "PostListData_hot_1.json"
        ]
        
        for fileName in networkFiles {
            _ = JSONService.loadPostsFromJSON(
                fileName: fileName,
                modelContext: modelContext
            )
        }
    }
    
    // åŠ è½½ç”¨æˆ·æœ¬åœ°æ•°æ®
    private func loadUserLocalData(modelContext: ModelContext) {
        let userPosts = UserPostManager.shared.loadUserPosts()
        
        for post in userPosts {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            let descriptor = FetchDescriptor<Post>(
                predicate: #Predicate<Post> { p in
                    p.id == post.id
                }
            )
            
            let existing = try? modelContext.fetch(descriptor)
            if existing?.isEmpty ?? true {
                modelContext.insert(post)
            }
        }
        
        try? modelContext.save()
    }
}
```

#### 3.3 æ•°æ®å±•ç¤ºç­–ç•¥

```swift
struct PostListView: View {
    @Query private var allPosts: [Post]
    @State private var filterType: PostFilterType = .all
    
    enum PostFilterType {
        case all           // å…¨éƒ¨
        case network       // ä»…ç½‘ç»œ
        case local         // ä»…æœ¬åœ°
    }
    
    var filteredPosts: [Post] {
        switch filterType {
        case .all:
            return allPosts
        case .network:
            return allPosts.filter { $0.isNetworkPost }
        case .local:
            return allPosts.filter { $0.isLocalPost }
        }
    }
    
    var body: some View {
        VStack {
            // ç­›é€‰å™¨
            Picker("æ•°æ®æº", selection: $filterType) {
                Text("å…¨éƒ¨").tag(PostFilterType.all)
                Text("ç½‘ç»œ").tag(PostFilterType.network)
                Text("æœ¬åœ°").tag(PostFilterType.local)
            }
            .pickerStyle(.segmented)
            .padding()
            
            // å¸–å­åˆ—è¡¨
            List(filteredPosts) { post in
                PostCellView(post: post)
                    .overlay(alignment: .topTrailing) {
                        // æ˜¾ç¤ºæ•°æ®æºæ ‡ç­¾
                        if post.isLocalPost {
                            Text("æœ¬åœ°")
                                .font(.caption2)
                                .padding(4)
                                .background(Color.blue.opacity(0.2))
                                .cornerRadius(4)
                        }
                    }
            }
        }
    }
}
```

---

### 4. å®Œæ•´çš„æ·»åŠ å¸–å­æµç¨‹

```swift
struct AddPostView: View {
    @Environment(\.modelContext) private var modelContext
    @Environment(\.dismiss) private var dismiss
    
    @State private var name = ""
    @State private var text = ""
    @State private var selectedPhotos: [PhotosPickerItem] = []
    @State private var selectedVideoItem: PhotosPickerItem?
    @State private var localImagePaths: [String] = []
    @State private var localVideoPath: String = ""
    @State private var isProcessing = false
    
    var body: some View {
        NavigationView {
            Form {
                Section("åŸºæœ¬ä¿¡æ¯") {
                    TextField("ç”¨æˆ·å", text: $name)
                    TextEditor(text: $text)
                        .frame(height: 100)
                }
                
                Section("åª’ä½“å†…å®¹") {
                    // å›¾ç‰‡é€‰æ‹©
                    PhotosPicker(
                        selection: $selectedPhotos,
                        maxSelectionCount: 9,
                        matching: .images
                    ) {
                        Label("é€‰æ‹©å›¾ç‰‡ï¼ˆæœ€å¤š9å¼ ï¼‰", systemImage: "photo.on.rectangle")
                    }
                    
                    if !localImagePaths.isEmpty {
                        Text("å·²é€‰æ‹© \(localImagePaths.count) å¼ å›¾ç‰‡")
                            .foregroundColor(.secondary)
                    }
                    
                    // è§†é¢‘é€‰æ‹©
                    PhotosPicker(
                        selection: $selectedVideoItem,
                        matching: .videos
                    ) {
                        Label("é€‰æ‹©è§†é¢‘", systemImage: "video")
                    }
                    
                    if !localVideoPath.isEmpty {
                        Text("å·²é€‰æ‹©è§†é¢‘")
                            .foregroundColor(.green)
                    }
                }
            }
            .navigationTitle("å‘å¸ƒå¸–å­")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("å–æ¶ˆ") {
                        dismiss()
                    }
                }
                
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("å‘å¸ƒ") {
                        Task {
                            await savePost()
                        }
                    }
                    .disabled(name.isEmpty || text.isEmpty || isProcessing)
                }
            }
            .overlay {
                if isProcessing {
                    ProgressView("æ­£åœ¨ä¿å­˜...")
                        .padding()
                        .background(Color(.systemBackground))
                        .cornerRadius(10)
                        .shadow(radius: 10)
                }
            }
        }
        .onChange(of: selectedPhotos) { _, newItems in
            Task {
                await loadPhotos(from: newItems)
            }
        }
        .onChange(of: selectedVideoItem) { _, newItem in
            Task {
                await loadVideo(from: newItem)
            }
        }
    }
    
    private func loadPhotos(from items: [PhotosPickerItem]) async {
        localImagePaths.removeAll()
        
        for item in items {
            if let data = try? await item.loadTransferable(type: Data.self) {
                let path = MediaManager.shared.saveMedia(data: data, type: .image)
                if !path.isEmpty {
                    localImagePaths.append(path)
                }
            }
        }
    }
    
    private func loadVideo(from item: PhotosPickerItem?) async {
        guard let item = item else { return }
        
        if let data = try? await item.loadTransferable(type: Data.self) {
            localVideoPath = MediaManager.shared.saveMedia(data: data, type: .video)
        }
    }
    
    private func savePost() async {
        isProcessing = true
        
        // 1. ç”Ÿæˆæ–° ID
        let newId = UserPostManager.shared.generateNewUserPostID(modelContext: modelContext)
        
        // 2. æ ¼å¼åŒ–æ—¥æœŸ
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "yyyy-MM-dd HH:mm"
        let dateString = dateFormatter.string(from: Date())
        
        // 3. åˆ›å»º Post å¯¹è±¡
        let newPost = Post(
            id: newId,
            avatar: "local://default_avatar",
            vip: false,
            name: name,
            date: dateString,
            isFollowed: false,
            text: text,
            images: localImagePaths,
            commentCount: 0,
            likeCount: 0,
            isLiked: false,
            videoUrl: localVideoPath
        )
        
        // 4. ä¿å­˜åˆ° SwiftData
        modelContext.insert(newPost)
        
        do {
            try modelContext.save()
            print("âœ… å¸–å­å·²ä¿å­˜åˆ° SwiftDataï¼ŒID: \(newId)")
        } catch {
            print("âŒ ä¿å­˜å¤±è´¥: \(error)")
            isProcessing = false
            return
        }
        
        // 5. ä¿å­˜åˆ°ç”¨æˆ· JSON æ–‡ä»¶
        _ = UserPostManager.shared.saveUserPost(newPost, modelContext: modelContext)
        
        isProcessing = false
        dismiss()
    }
}
```

---

## ğŸ”„ ç½‘ç»œæ•°æ®ä¸æœ¬åœ°æ•°æ®äº¤äº’

### åœºæ™¯ 1ï¼šçº¯æœ¬åœ°æ¨¡å¼ï¼ˆå½“å‰éœ€æ±‚ï¼‰

```
ç”¨æˆ·åˆ›å»ºå¸–å­
    â†“
ä¿å­˜åˆ° SwiftData (ID: 10000+)
    â†“
ä¿å­˜åˆ° UserPosts.json
    â†“
æœ¬åœ°å±•ç¤ºï¼ˆä¸å‘é€ç½‘ç»œï¼‰
```

### åœºæ™¯ 2ï¼šæœªæ¥ç½‘ç»œåŒæ­¥æ¨¡å¼

```
ç”¨æˆ·åˆ›å»ºå¸–å­ï¼ˆæœ¬åœ°ï¼‰
    â†“
ä¿å­˜åˆ° SwiftData (ID: 10000+, status: pending)
    â†“
ä¿å­˜åˆ° UserPosts.json
    â†“
æœ¬åœ°å±•ç¤º
    â†“
[ç”¨æˆ·ç‚¹å‡»"åŒæ­¥åˆ°äº‘ç«¯"]
    â†“
ä¸Šä¼ åˆ°æœåŠ¡å™¨
    â†“
æœåŠ¡å™¨è¿”å›æ–° ID (ä¾‹å¦‚: 50001)
    â†“
æ›´æ–°æœ¬åœ°è®°å½• (ID: 10001 â†’ 50001, status: synced)
    â†“
æ›´æ–° SwiftData å’Œ JSON
```

#### å®ç°ä»£ç æ¡†æ¶

```swift
// æ‰©å±• Post æ¨¡å‹æ”¯æŒåŒæ­¥çŠ¶æ€
extension Post {
    enum SyncStatus: String, Codable {
        case local      // ä»…æœ¬åœ°
        case pending    // å¾…åŒæ­¥
        case synced     // å·²åŒæ­¥
        case failed     // åŒæ­¥å¤±è´¥
    }
    
    // å¯ä»¥æ·»åŠ ä¸€ä¸ª syncStatus å±æ€§
    // var syncStatus: String = SyncStatus.local.rawValue
}

class SyncManager {
    static let shared = SyncManager()
    
    // åŒæ­¥æœ¬åœ°å¸–å­åˆ°æœåŠ¡å™¨
    func syncLocalPost(_ post: Post, completion: @escaping (Result<Int, Error>) -> Void) {
        // 1. ä¸Šä¼ åª’ä½“æ–‡ä»¶
        uploadMedia(for: post) { mediaResult in
            switch mediaResult {
            case .success(let mediaURLs):
                // 2. ä¸Šä¼ å¸–å­æ•°æ®
                self.uploadPost(post, mediaURLs: mediaURLs, completion: completion)
            case .failure(let error):
                completion(.failure(error))
            }
        }
    }
    
    private func uploadMedia(for post: Post, completion: @escaping (Result<[String], Error>) -> Void) {
        // å®ç°åª’ä½“æ–‡ä»¶ä¸Šä¼ é€»è¾‘
        // è¿”å›æœåŠ¡å™¨ä¸Šçš„ URL
    }
    
    private func uploadPost(_ post: Post, mediaURLs: [String], completion: @escaping (Result<Int, Error>) -> Void) {
        // å®ç°å¸–å­æ•°æ®ä¸Šä¼ é€»è¾‘
        // è¿”å›æœåŠ¡å™¨åˆ†é…çš„æ–° ID
    }
}
```

---

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å¯åŠ¨                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   åˆå§‹åŒ– SwiftData æ•°æ®åº“      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ åŠ è½½ç½‘ç»œæ•°æ®  â”‚        â”‚ åŠ è½½æœ¬åœ°æ•°æ®  â”‚
    â”‚ (Bundle JSON)â”‚        â”‚(Documents JSON)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                       â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  åˆå¹¶åˆ° SwiftData      â”‚
            â”‚  ID: 1000-3999 (ç½‘ç»œ) â”‚
            â”‚  ID: 10000+ (æœ¬åœ°)    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    å±•ç¤ºå¸–å­åˆ—è¡¨        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½ï¼ˆ1-2å¤©ï¼‰

1. âœ… åˆ›å»º `MediaManager` ç±»
2. âœ… åˆ›å»º `UserPostManager` ç±»
3. âœ… ä¿®æ”¹ `AddPostView` æ”¯æŒå›¾ç‰‡/è§†é¢‘é€‰æ‹©
4. âœ… å®ç°æœ¬åœ°åª’ä½“æ–‡ä»¶ä¿å­˜
5. âœ… å®ç°ç”¨æˆ·å¸–å­ JSON ç®¡ç†

### ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®éš”ç¦»ï¼ˆ1å¤©ï¼‰

1. âœ… æ‰©å±• `Post` æ¨¡å‹æ·»åŠ æ•°æ®æºåˆ¤æ–­
2. âœ… å®ç° `DataLoadManager` ç»Ÿä¸€æ•°æ®åŠ è½½
3. âœ… æ·»åŠ æ•°æ®æºç­›é€‰åŠŸèƒ½
4. âœ… æ·»åŠ æœ¬åœ°æ ‡è¯†æ˜¾ç¤º

### ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–ä½“éªŒï¼ˆ1å¤©ï¼‰

1. âœ… æ·»åŠ å›¾ç‰‡å‹ç¼©åŠŸèƒ½
2. âœ… æ·»åŠ è§†é¢‘ç¼©ç•¥å›¾ç”Ÿæˆ
3. âœ… æ·»åŠ åª’ä½“é¢„è§ˆåŠŸèƒ½
4. âœ… æ·»åŠ åˆ é™¤ç¡®è®¤å’Œåª’ä½“æ¸…ç†

### ç¬¬å››é˜¶æ®µï¼šæœªæ¥æ‰©å±•ï¼ˆå¯é€‰ï¼‰

1. â³ å®ç°äº‘åŒæ­¥åŠŸèƒ½
2. â³ æ·»åŠ è‰ç¨¿ç®±åŠŸèƒ½
3. â³ æ·»åŠ æ•°æ®å¯¼å‡º/å¯¼å…¥
4. â³ æ·»åŠ æ•°æ®ç»Ÿè®¡åŠŸèƒ½

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ•°æ®éš”ç¦»**ï¼šé€šè¿‡ ID èŒƒå›´åŒºåˆ†ç½‘ç»œæ•°æ®ï¼ˆ1000-9999ï¼‰å’Œæœ¬åœ°æ•°æ®ï¼ˆ10000+ï¼‰
2. **æ–‡ä»¶ç®¡ç†**ï¼šç‹¬ç«‹çš„ `UserPosts.json` ç®¡ç†ç”¨æˆ·åˆ›å»ºçš„å¸–å­
3. **åª’ä½“å­˜å‚¨**ï¼šæœ¬åœ° `UserMedia` ç›®å½•å­˜å‚¨å›¾ç‰‡å’Œè§†é¢‘
4. **ç»Ÿä¸€å±•ç¤º**ï¼šSwiftData ç»Ÿä¸€ç®¡ç†ï¼Œæ”¯æŒç­›é€‰å’Œæ··åˆå±•ç¤º
5. **å¯æ‰©å±•æ€§**ï¼šé¢„ç•™äº‘åŒæ­¥æ¥å£ï¼Œä¾¿äºæœªæ¥æ‰©å±•

### ä¼˜åŠ¿

- âœ… **æ¸…æ™°çš„æ•°æ®è¾¹ç•Œ**ï¼šç½‘ç»œæ•°æ®å’Œæœ¬åœ°æ•°æ®å®Œå…¨éš”ç¦»
- âœ… **çµæ´»çš„å±•ç¤ºæ–¹å¼**ï¼šæ”¯æŒå…¨éƒ¨/ç½‘ç»œ/æœ¬åœ°ç­›é€‰
- âœ… **å®Œæ•´çš„æœ¬åœ°ä½“éªŒ**ï¼šæ— éœ€ç½‘ç»œå³å¯åˆ›å»ºå’ŒæŸ¥çœ‹
- âœ… **ä¾¿äºæœªæ¥æ‰©å±•**ï¼šé¢„ç•™äº‘åŒæ­¥èƒ½åŠ›

### æ³¨æ„äº‹é¡¹

1. **å­˜å‚¨ç©ºé—´ç®¡ç†**ï¼šå®šæœŸæ¸…ç†æ— ç”¨çš„åª’ä½“æ–‡ä»¶
2. **å›¾ç‰‡å‹ç¼©**ï¼šä¸Šä¼ å‰å‹ç¼©å›¾ç‰‡ï¼ŒèŠ‚çœç©ºé—´
3. **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯æç¤ºå’Œæ¢å¤æœºåˆ¶
4. **æ•°æ®å¤‡ä»½**ï¼šæä¾›æ•°æ®å¯¼å‡ºåŠŸèƒ½ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-29  
**é€‚ç”¨é¡¹ç›®**: newTestSwiftData

