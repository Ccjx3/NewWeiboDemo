# SwiftData 帖子列表构建方案

## 📋 项目概述

本项目使用 SwiftData 构建一个社交媒体帖子列表应用，支持从 JSON 文件加载数据、展示帖子列表、添加新帖子，并将数据同步回 JSON 文件。

## 🏗️ 架构设计

### 1. 数据模型层（Models）

#### Post 模型
- **位置**: `Models/Post.swift`
- **作用**: 定义帖子的数据结构
- **关键特性**:
  - 使用 `@Model` 宏标记，SwiftData 会自动管理持久化
  - 包含所有 JSON 字段的对应属性
  - 提供 `from json:` 和 `toJSON()` 方法用于 JSON 转换
  - 实现 `Identifiable` 协议，支持 SwiftUI 列表展示

#### 为什么这样设计？
- **@Model 宏**: SwiftData 的核心，自动生成持久化代码，无需手动编写 Core Data 的复杂配置
- **String 存储图片**: 图片文件名存储在数据库中，实际图片文件在 Resources 文件夹，这样设计可以：
  - 节省数据库空间
  - 提高查询性能
  - 便于图片资源管理
  - 支持异步加载图片

### 2. 服务层（Services）

#### JSONService
- **位置**: `Services/JSONService.swift`
- **作用**: 处理 JSON 文件的读取和写入
- **主要方法**:
  - `loadPostsFromJSON()`: 从 Bundle 的 JSON 文件加载数据到 SwiftData
  - `savePostsToJSON()`: 将 SwiftData 数据保存到 Documents 目录的 JSON 文件

#### 为什么这样设计？
- **分离关注点**: 数据加载逻辑独立，便于维护和测试
- **Bundle vs Documents**: 
  - Bundle 是只读的，用于初始数据
  - Documents 是可写的，用于保存用户修改
- **去重处理**: 加载时检查 ID，避免重复数据

### 3. 视图层（Views）

#### PostListView
- **位置**: `Views/PostListView.swift`
- **作用**: 展示帖子列表的主视图
- **功能**:
  - 使用 `@Query` 自动获取 SwiftData 数据
  - 支持添加、删除帖子
  - 自动同步到 JSON 文件

#### PostCellView
- **作用**: 单个帖子的展示单元格
- **功能**:
  - 展示用户信息、内容、图片
  - 支持点赞、关注操作
  - 使用 `AsyncImage` 异步加载图片

#### AddPostView
- **作用**: 添加新帖子的表单视图
- **功能**:
  - 输入帖子信息
  - 自动生成新 ID
  - 保存到 SwiftData 并同步到 JSON

## 📊 数据流

```
JSON 文件 (Bundle)
    ↓
JSONService.loadPostsFromJSON()
    ↓
SwiftData (Post 模型)
    ↓
@Query 自动查询
    ↓
PostListView 展示
    ↓
用户操作 (添加/修改/删除)
    ↓
modelContext.save()
    ↓
JSONService.savePostsToJSON()
    ↓
JSON 文件 (Documents)
```

## 🔄 同步机制

### 何时同步？
1. **加载时**: 应用启动时从 JSON 加载到 SwiftData
2. **添加时**: 添加新帖子后立即同步
3. **删除时**: 删除帖子后立即同步
4. **修改时**: 点赞、关注等操作后同步（可选，也可以批量同步）

### 同步策略
- **实时同步**: 每次操作都同步（适合数据量小的场景）
- **批量同步**: 定时或退出时同步（适合数据量大的场景）
- **手动同步**: 用户点击按钮时同步

## 🖼️ 图片处理方案

### SwiftData 中图片的存储方式

SwiftData 提供了几种存储图片的方式：

#### 1. 存储为 String（文件名/URL）✅ 推荐
```swift
var avatar: String  // 存储文件名
var images: [String]  // 存储文件名数组
```
**优点**:
- 数据库体积小
- 查询速度快
- 支持异步加载
- 便于资源管理

**缺点**:
- 需要手动管理图片文件
- 文件丢失会导致显示问题

#### 2. 存储为 Data（二进制数据）
```swift
@Attribute(.externalStorage) var avatarData: Data?
```
**优点**:
- 数据完整性好
- 不需要单独管理文件

**缺点**:
- 数据库体积大
- 加载速度慢
- 不适合大量图片

#### 3. 存储为 URL
```swift
var imageURL: URL?
```
**优点**:
- 支持远程图片
- 灵活性高

**缺点**:
- 需要网络请求
- 需要缓存机制

### 本项目选择方案 1 的原因
- JSON 文件中就是文件名
- 图片文件在 Resources 文件夹，便于管理
- 性能最优
- 符合现有数据结构

## 📝 使用流程

### 1. 初始化数据
```swift
// 在 App 启动时加载 JSON 数据
let posts = JSONService.loadPostsFromJSON(
    fileName: "PostListData_recommend_1.json",
    modelContext: modelContext
)
```

### 2. 展示数据
```swift
// 使用 @Query 自动查询
@Query(sort: \Post.id) private var posts: [Post]

// 在视图中直接使用
ForEach(posts) { post in
    PostCellView(post: post)
}
```

### 3. 添加新帖子
```swift
// 创建新 Post
let newPost = Post(...)
modelContext.insert(newPost)
try? modelContext.save()

// 同步到 JSON
JSONService.savePostsToJSON(
    fileName: "PostListData_recommend_1.json",
    modelContext: modelContext
)
```

### 4. 修改数据
```swift
// 直接修改 @Bindable 属性
post.isLiked = true
post.likeCount += 1

// SwiftData 会自动检测变化，但需要手动保存
try? modelContext.save()

// 同步到 JSON
JSONService.savePostsToJSON(...)
```

### 5. 删除数据
```swift
modelContext.delete(post)
try? modelContext.save()

// 同步到 JSON
JSONService.savePostsToJSON(...)
```

## 🎯 最佳实践

1. **数据一致性**: 确保 SwiftData 和 JSON 文件保持同步
2. **错误处理**: 所有文件操作都要有错误处理
3. **性能优化**: 大量数据时使用批量操作
4. **用户体验**: 操作后立即反馈，异步同步
5. **资源管理**: 图片使用异步加载，避免阻塞 UI

## 🔧 扩展建议

1. **分页加载**: 数据量大时实现分页
2. **搜索功能**: 添加搜索和筛选
3. **缓存机制**: 图片缓存到本地
4. **网络同步**: 支持从服务器同步数据
5. **数据迁移**: 版本更新时的数据迁移策略
