# å¾®åšDemo - ä¸Šæ‹‰åˆ·æ–°å’Œä¸‹æ‹‰åŠ è½½æ›´å¤šåŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ ç›®å½•
- [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [æ ¸å¿ƒå®ç°](#æ ¸å¿ƒå®ç°)
- [è¯¦ç»†å®ç°æ­¥éª¤](#è¯¦ç»†å®ç°æ­¥éª¤)
- [ä»£ç æµç¨‹å›¾](#ä»£ç æµç¨‹å›¾)
- [å…³é”®ä»£ç è§£æ](#å…³é”®ä»£ç è§£æ)

---

## åŠŸèƒ½æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†ç±»ä¼¼å¾®åšçš„åˆ—è¡¨åˆ·æ–°åŠŸèƒ½ï¼š
- **ä¸‹æ‹‰åˆ·æ–°ï¼ˆPull to Refreshï¼‰**ï¼šç”¨æˆ·ä¸‹æ‹‰åˆ—è¡¨æ—¶ï¼Œé‡æ–°åŠ è½½æœ€æ–°æ•°æ®
- **ä¸Šæ‹‰åŠ è½½æ›´å¤šï¼ˆPull to Load Moreï¼‰**ï¼šç”¨æˆ·æ»‘åŠ¨åˆ°åˆ—è¡¨åº•éƒ¨æ—¶ï¼Œè‡ªåŠ¨åŠ è½½æ›´å¤šå†å²æ•°æ®

---

## æŠ€æœ¯æ ˆ

### æ ¸å¿ƒä¾èµ–
- **SwiftUI**ï¼šUIæ¡†æ¶
- **BBSwiftUIKit**ï¼šç¬¬ä¸‰æ–¹åº“ï¼Œæä¾› `BBTableView` åŠåˆ·æ–°æ§ä»¶
- **Alamofire**ï¼šç½‘ç»œè¯·æ±‚åº“
- **Combine**ï¼šå“åº”å¼ç¼–ç¨‹æ¡†æ¶ï¼ˆç”¨äºæ•°æ®ç»‘å®šï¼‰

### å…³é”®ç»„ä»¶
| ç»„ä»¶ | ä½œç”¨ |
|------|------|
| `BBTableView` | å°è£…çš„åˆ—è¡¨è§†å›¾ï¼Œæ”¯æŒåˆ·æ–°åŠŸèƒ½ |
| `UserData` | æ•°æ®ç®¡ç†ç±»ï¼ˆObservableObjectï¼‰ |
| `NetworkAPI` | ç½‘ç»œè¯·æ±‚æ¥å£ |
| `NetworkManager` | ç½‘ç»œè¯·æ±‚ç®¡ç†å™¨ |

---

## æ ¸å¿ƒå®ç°

### 1. ä½¿ç”¨ BBSwiftUIKit çš„åˆ·æ–°ç»„ä»¶

åœ¨ `PostListView.swift` ä¸­ï¼Œé€šè¿‡ `BBTableView` åŠå…¶ä¿®é¥°ç¬¦å®ç°åˆ·æ–°åŠŸèƒ½ï¼š

```swift
BBTableView(userData.postList(for: category).list) { post in
    NavigationLink(destination: PostDetailView(post: post)) {
        PostCell(post: post)
    }
    .buttonStyle(OriginalButtonStyle())
}
.bb_setupRefreshControl { control in
    control.attributedTitle = NSAttributedString(string: "åŠ è½½ä¸­...")
}
.bb_pullDownToRefresh(isRefreshing: $userData.isRefreshing) {
    self.userData.refreshPostlist(for: self.category)
}
.bb_pullUpToLoadMore(bottomSpace: 30) {
    self.userData.loadMorePostList(for: self.category)
}
.bb_reloadData($userData.reloadData)
```

### 2. æ•°æ®ç®¡ç†ï¼ˆUserDataï¼‰

`UserData` ç±»è´Ÿè´£ç®¡ç†æ•°æ®çŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘ï¼š

```swift
class UserData: ObservableObject {
    @Published var recommendPostList: PostList = PostList(list: [])
    @Published var hotPostList: PostList = PostList(list: [])
    @Published var isRefreshing: Bool = false
    @Published var isLoadingMore: Bool = false
    @Published var loadingError: Error?
    @Published var reloadData: Bool = false
    
    private var recommendPostDic: [Int: Int] = [:] // ç”¨äºå»é‡
    private var hotPostDic: [Int: Int] = [:]
}
```

---

## è¯¦ç»†å®ç°æ­¥éª¤

### æ­¥éª¤ 1ï¼šé…ç½® BBTableView

åœ¨è§†å›¾ä¸­ä½¿ç”¨ `BBTableView` æ›¿ä»£åŸç”Ÿ `List`ï¼š

```swift
BBTableView(userData.postList(for: category).list) { post in
    // åˆ—è¡¨é¡¹å†…å®¹
    PostCell(post: post)
}
```

**ä½œç”¨**ï¼š`BBTableView` æ˜¯å¯¹ UITableView çš„ SwiftUI å°è£…ï¼Œæ”¯æŒåˆ·æ–°æ§ä»¶ã€‚

---

### æ­¥éª¤ 2ï¼šè®¾ç½®ä¸‹æ‹‰åˆ·æ–°

#### 2.1 é…ç½®åˆ·æ–°æ§ä»¶æ ·å¼
```swift
.bb_setupRefreshControl { control in
    control.attributedTitle = NSAttributedString(string: "åŠ è½½ä¸­...")
}
```

#### 2.2 ç»‘å®šåˆ·æ–°çŠ¶æ€å’Œå›è°ƒ
```swift
.bb_pullDownToRefresh(isRefreshing: $userData.isRefreshing) {
    self.userData.refreshPostlist(for: self.category)
}
```

**å‚æ•°è¯´æ˜**ï¼š
- `isRefreshing`ï¼šç»‘å®šåˆ·æ–°çŠ¶æ€ï¼ˆåŒå‘ç»‘å®šï¼‰
- é—­åŒ…ï¼šè§¦å‘åˆ·æ–°æ—¶æ‰§è¡Œçš„æ“ä½œ

#### 2.3 å®ç°åˆ·æ–°é€»è¾‘ï¼ˆUserDataï¼‰
```swift
func refreshPostlist(for category: PostListCategory) {
    let completion: (Result<PostList, Error>) -> Void = { result in
        switch result {
        case let .success(list): 
            self.handleRefreshPostList(list, for: category)
        case let .failure(error): 
            self.handleLoadingError(error)
        }
        self.isRefreshing = false // ç»“æŸåˆ·æ–°çŠ¶æ€
    }
    
    switch category {
    case .recommend:
        NetworkAPI.recommendPostList(completion: completion)
    case .hot:
        NetworkAPI.hotPostList(completion: completion)
    }
}
```

#### 2.4 å¤„ç†åˆ·æ–°æ•°æ®ï¼ˆå»é‡ï¼‰
```swift
private func handleRefreshPostList(_ list: PostList, for category: PostListCategory) {
    var tempList: [Post] = []
    var tempDic: [Int : Int] = [:]
    
    // å»é‡é€»è¾‘
    for (index, post) in list.list.enumerated() {
        if tempDic[post.id] != nil { continue } // è·³è¿‡é‡å¤é¡¹
        tempList.append(post)
        tempDic[post.id] = index
        update(post)
    }
    
    // æ›´æ–°æ•°æ®
    switch category {
    case .recommend:
        recommendPostList.list = tempList
        recommendPostDic = tempDic
    case .hot:
        hotPostList.list = tempList
        hotPostDic = tempDic
    }
    
    reloadData = true // è§¦å‘åˆ—è¡¨é‡æ–°åŠ è½½
}
```

---

### æ­¥éª¤ 3ï¼šè®¾ç½®ä¸Šæ‹‰åŠ è½½æ›´å¤š

#### 3.1 é…ç½®åŠ è½½æ›´å¤šè§¦å‘æ¡ä»¶
```swift
.bb_pullUpToLoadMore(bottomSpace: 30) {
    self.userData.loadMorePostList(for: self.category)
}
```

**å‚æ•°è¯´æ˜**ï¼š
- `bottomSpace: 30`ï¼šè·ç¦»åº•éƒ¨ 30pt æ—¶è§¦å‘åŠ è½½
- é—­åŒ…ï¼šè§¦å‘åŠ è½½æ›´å¤šæ—¶æ‰§è¡Œçš„æ“ä½œ

#### 3.2 å®ç°åŠ è½½æ›´å¤šé€»è¾‘
```swift
func loadMorePostList(for category: PostListCategory) {
    // é˜²æ­¢é‡å¤åŠ è½½ & é™åˆ¶æœ€å¤§æ•°é‡
    if isLoadingMore || postList(for: category).list.count > 10 { return }
    
    isLoadingMore = true
    
    let completion: (Result<PostList, Error>) -> Void = { result in
        switch result {
        case let .success(list): 
            self.handleLoadMorePostList(list, for: category)
        case let .failure(error): 
            self.handleLoadingError(error)
        }
        self.isLoadingMore = false
    }
    
    // å‘èµ·ç½‘ç»œè¯·æ±‚
    switch category {
    case .recommend:
        NetworkAPI.hotPostList(completion: completion)
    case .hot:
        NetworkAPI.recommendPostList(completion: completion)
    }
}
```

#### 3.3 å¤„ç†åŠ è½½æ›´å¤šæ•°æ®ï¼ˆè¿½åŠ  & å»é‡ï¼‰
```swift
private func handleLoadMorePostList(_ list: PostList, for category: PostListCategory) {
    switch category {
    case .recommend:
        for post in list.list {
            update(post)
            if recommendPostDic[post.id] != nil { continue } // å»é‡
            recommendPostList.list.append(post) // è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾
            recommendPostDic[post.id] = recommendPostList.list.count - 1
        }
    case .hot:
        for post in list.list {
            update(post)
            if hotPostDic[post.id] != nil { continue }
            hotPostList.list.append(post)
            hotPostDic[post.id] = hotPostList.list.count - 1
        }
    }
}
```

---

### æ­¥éª¤ 4ï¼šç»‘å®šæ•°æ®é‡è½½

```swift
.bb_reloadData($userData.reloadData)
```

**ä½œç”¨**ï¼šå½“ `reloadData` å˜ä¸º `true` æ—¶ï¼Œè§¦å‘åˆ—è¡¨é‡æ–°æ¸²æŸ“ã€‚

---

### æ­¥éª¤ 5ï¼šé¦–æ¬¡åŠ è½½æ•°æ®

```swift
.onAppear {
    self.userData.loadPostListIfNeeded(for: self.category)
}
```

```swift
func loadPostListIfNeeded(for category: PostListCategory) {
    if postList(for: category).list.isEmpty {
        refreshPostlist(for: category)
    }
}
```

**ä½œç”¨**ï¼šè§†å›¾é¦–æ¬¡å‡ºç°æ—¶ï¼Œå¦‚æœåˆ—è¡¨ä¸ºç©ºåˆ™è‡ªåŠ¨åŠ è½½æ•°æ®ã€‚

---

## ä»£ç æµç¨‹å›¾

### ä¸‹æ‹‰åˆ·æ–°æµç¨‹

```
ç”¨æˆ·ä¸‹æ‹‰åˆ—è¡¨
    â†“
è§¦å‘ bb_pullDownToRefresh å›è°ƒ
    â†“
è°ƒç”¨ userData.refreshPostlist(for: category)
    â†“
è®¾ç½® isRefreshing = trueï¼ˆæ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨ï¼‰
    â†“
å‘èµ·ç½‘ç»œè¯·æ±‚ NetworkAPI.recommendPostList/hotPostList
    â†“
æ”¶åˆ°å“åº”æ•°æ®
    â†“
handleRefreshPostListï¼ˆå»é‡ + æ›´æ–°æ•°æ®ï¼‰
    â†“
è®¾ç½® isRefreshing = falseï¼ˆéšè—åŠ è½½æŒ‡ç¤ºå™¨ï¼‰
    â†“
è®¾ç½® reloadData = trueï¼ˆè§¦å‘åˆ—è¡¨åˆ·æ–°ï¼‰
    â†“
åˆ—è¡¨æ˜¾ç¤ºæœ€æ–°æ•°æ®
```

### ä¸Šæ‹‰åŠ è½½æ›´å¤šæµç¨‹

```
ç”¨æˆ·æ»‘åŠ¨åˆ°åˆ—è¡¨åº•éƒ¨ï¼ˆè·ç¦»åº•éƒ¨ 30ptï¼‰
    â†“
è§¦å‘ bb_pullUpToLoadMore å›è°ƒ
    â†“
æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½ & æ•°æ®é‡æ˜¯å¦è¶…é™
    â†“
è°ƒç”¨ userData.loadMorePostList(for: category)
    â†“
è®¾ç½® isLoadingMore = true
    â†“
å‘èµ·ç½‘ç»œè¯·æ±‚ NetworkAPI.recommendPostList/hotPostList
    â†“
æ”¶åˆ°å“åº”æ•°æ®
    â†“
handleLoadMorePostListï¼ˆå»é‡ + è¿½åŠ æ•°æ®ï¼‰
    â†“
è®¾ç½® isLoadingMore = false
    â†“
åˆ—è¡¨è‡ªåŠ¨æ˜¾ç¤ºæ–°è¿½åŠ çš„æ•°æ®
```

---

## å…³é”®ä»£ç è§£æ

### 1. BBTableView çš„ä½œç”¨

`BBTableView` æ˜¯ `BBSwiftUIKit` åº“æä¾›çš„ç»„ä»¶ï¼Œå®ƒï¼š
- å°è£…äº† UITableViewï¼Œä½¿å…¶å¯ä»¥åœ¨ SwiftUI ä¸­ä½¿ç”¨
- æä¾›äº† `.bb_pullDownToRefresh` å’Œ `.bb_pullUpToLoadMore` ä¿®é¥°ç¬¦
- æ”¯æŒä¸ SwiftUI çš„ `@Published` å±æ€§åŒå‘ç»‘å®š

### 2. æ•°æ®å»é‡æœºåˆ¶

ä½¿ç”¨å­—å…¸ `[Int: Int]` å­˜å‚¨ `postId: index` æ˜ å°„ï¼š

```swift
private var recommendPostDic: [Int: Int] = [:]
```

**ä¼˜åŠ¿**ï¼š
- O(1) æ—¶é—´å¤æ‚åº¦æŸ¥æ‰¾é‡å¤é¡¹
- å¿«é€Ÿå®šä½å’Œæ›´æ–°æŒ‡å®š post

### 3. çŠ¶æ€ç®¡ç†

ä½¿ç”¨ `@Published` å±æ€§å®ç°å“åº”å¼æ›´æ–°ï¼š

```swift
@Published var isRefreshing: Bool = false
@Published var isLoadingMore: Bool = false
@Published var reloadData: Bool = false
```

å½“è¿™äº›å±æ€§å˜åŒ–æ—¶ï¼ŒSwiftUI ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“ç›¸å…³è§†å›¾ã€‚

### 4. é”™è¯¯å¤„ç†

```swift
private func handleLoadingError(_ error: Error) {
    loadingError = error
    DispatchQueue.main.asyncAfter(deadline: .now() + 1.5) {
        self.loadingError = nil
    }
}
```

**ç‰¹ç‚¹**ï¼š
- æ˜¾ç¤ºé”™è¯¯æç¤º 1.5 ç§’åè‡ªåŠ¨æ¶ˆå¤±
- é€šè¿‡ `overlay` åœ¨åˆ—è¡¨ä¸Šæ–¹æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

### 5. ç½‘ç»œè¯·æ±‚å°è£…

#### NetworkManagerï¼ˆåº•å±‚ï¼‰
```swift
func requestGet(path: String, parameters: Parameters?, completion: @escaping NetworkRequestCompletion) -> DataRequest {
    AF.request(NetworkAPIBaseURL + path,
               parameters: parameters,
               headers: commonHeaders,
               requestModifier: { $0.timeoutInterval = 15 })
        .responseData { response in
            switch response.result {
            case let .success(data): completion(.success(data))
            case let .failure(error): completion(self.handleError(error))
            }
    }
}
```

#### NetworkAPIï¼ˆä¸šåŠ¡å±‚ï¼‰
```swift
static func recommendPostList(completion: @escaping (Result<PostList, Error>) -> Void) {
    NetworkManager.shared.requestGet(path: "PostListData_recommend_1.json", parameters: nil) { result in
        switch result {
        case let .success(data):
            let parseResult: Result<PostList, Error> = self.parseData(data)
            completion(parseResult)
        case let .failure(error):
            completion(.failure(error))
        }
    }
}
```

**åˆ†å±‚ä¼˜åŠ¿**ï¼š
- NetworkManager å¤„ç†é€šç”¨ç½‘ç»œé€»è¾‘ï¼ˆè¶…æ—¶ã€é”™è¯¯å¤„ç†ï¼‰
- NetworkAPI å¤„ç†å…·ä½“ä¸šåŠ¡æ¥å£å’Œæ•°æ®è§£æ

---

## æ€»ç»“

### å®ç°è¦ç‚¹

1. **ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ç®€åŒ–å¼€å‘**ï¼š`BBSwiftUIKit` æä¾›äº†å¼€ç®±å³ç”¨çš„åˆ·æ–°ç»„ä»¶
2. **æ•°æ®å»é‡**ï¼šä½¿ç”¨å­—å…¸å­˜å‚¨ ID æ˜ å°„ï¼Œé¿å…é‡å¤æ•°æ®
3. **çŠ¶æ€ç®¡ç†**ï¼šé€šè¿‡ `@Published` å®ç°å“åº”å¼æ›´æ–°
4. **é˜²æ­¢é‡å¤è¯·æ±‚**ï¼šä½¿ç”¨ `isRefreshing` å’Œ `isLoadingMore` æ ‡å¿—ä½
5. **é”™è¯¯å¤„ç†**ï¼šå‹å¥½çš„é”™è¯¯æç¤ºå’Œè‡ªåŠ¨æ¶ˆå¤±æœºåˆ¶

### ä¼˜åŠ¿

- âœ… ä»£ç ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»
- âœ… æ”¯æŒå¤šä¸ªåˆ†ç±»ï¼ˆæ¨èã€çƒ­é—¨ï¼‰ç‹¬ç«‹ç®¡ç†æ•°æ®
- âœ… è‡ªåŠ¨å»é‡ï¼Œé¿å…æ•°æ®é‡å¤
- âœ… è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼ˆåŠ è½½æç¤ºã€é”™è¯¯æç¤ºï¼‰

### å¯ä¼˜åŒ–ç‚¹

- ğŸ“Œ å¯ä»¥æ·»åŠ åˆ†é¡µå‚æ•°ï¼ˆå½“å‰æ˜¯å›ºå®šåŠ è½½åŒä¸€ä»½æ•°æ®ï¼‰
- ğŸ“Œ å¯ä»¥æ·»åŠ åŠ è½½æ›´å¤šçš„åº•éƒ¨æŒ‡ç¤ºå™¨
- ğŸ“Œ å¯ä»¥ä¼˜åŒ–ç½‘ç»œè¯·æ±‚çš„å–æ¶ˆæœºåˆ¶ï¼ˆå¿«é€Ÿåˆ‡æ¢åˆ†ç±»æ—¶ï¼‰
- ğŸ“Œ å¯ä»¥æ·»åŠ æœ¬åœ°ç¼“å­˜æœºåˆ¶

---

## é™„å½•ï¼šå®Œæ•´æ–‡ä»¶åˆ—è¡¨

| æ–‡ä»¶ | ä½œç”¨ |
|------|------|
| `PostListView.swift` | åˆ—è¡¨è§†å›¾ï¼Œé…ç½®åˆ·æ–°ç»„ä»¶ |
| `UserData.swift` | æ•°æ®ç®¡ç†ç±»ï¼Œå¤„ç†åˆ·æ–°å’ŒåŠ è½½é€»è¾‘ |
| `NetworkAPI.swift` | ç½‘ç»œæ¥å£å®šä¹‰ |
| `NetworkManager.swift` | ç½‘ç»œè¯·æ±‚ç®¡ç†å™¨ |
| `Post.swift` | æ•°æ®æ¨¡å‹ |
| `HomeView.swift` | ä¸»é¡µè§†å›¾ï¼ŒåŒ…å«æ¨èå’Œçƒ­é—¨ä¸¤ä¸ªåˆ—è¡¨ |

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**ï¼š2026å¹´1æœˆ29æ—¥  
**é¡¹ç›®åç§°**ï¼šWeiboDemo  
**æŠ€æœ¯æ ˆ**ï¼šSwiftUI + BBSwiftUIKit + Alamofire

