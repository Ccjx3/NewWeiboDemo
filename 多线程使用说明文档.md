# é¡¹ç›®å¤šçº¿ç¨‹ä½¿ç”¨è¯´æ˜æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯](#å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯)
3. [è¯¦ç»†åˆ†æ](#è¯¦ç»†åˆ†æ)
4. [æœ€ä½³å®è·µæ€»ç»“](#æœ€ä½³å®è·µæ€»ç»“)

---

## æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªç±»ä¼¼å¾®åšçš„ç¤¾äº¤åª’ä½“åº”ç”¨ï¼Œä½¿ç”¨ SwiftUI + SwiftData æ„å»ºã€‚åœ¨é¡¹ç›®ä¸­ï¼Œå¤šçº¿ç¨‹æŠ€æœ¯è¢«å¹¿æ³›åº”ç”¨äºä»¥ä¸‹å‡ ä¸ªå…³é”®åœºæ™¯ï¼š

- **ç½‘ç»œè¯·æ±‚å¤„ç†**
- **è§†é¢‘æ’­æ”¾çŠ¶æ€ç›‘å¬**
- **UI æ›´æ–°ä¸æ•°æ®åŒæ­¥**
- **å¼‚æ­¥æ•°æ®åŠ è½½**

åˆç†ä½¿ç”¨å¤šçº¿ç¨‹å¯ä»¥ç¡®ä¿åº”ç”¨çš„æµç•…æ€§ï¼Œé¿å…ä¸»çº¿ç¨‹é˜»å¡ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

---

## å¤šçº¿ç¨‹ä½¿ç”¨åœºæ™¯

### 1. è§†é¢‘æ’­æ”¾å™¨çŠ¶æ€ç›‘å¬ (`PostVideoPlayer.swift`)

#### ğŸ“ ä½ç½® 1ï¼šæ’­æ”¾å™¨çŠ¶æ€ç›‘å¬

```swift
// ç›‘å¬æ’­æ”¾å™¨çŠ¶æ€
playerItem.publisher(for: \.status)
    .receive(on: DispatchQueue.main)
    .sink { [weak manager] status in
        guard let manager = manager else { return }
        switch status {
        case .readyToPlay:
            print("âœ… è§†é¢‘å‡†å¤‡å°±ç»ª")
            manager.isLoading = false
            manager.loadError = false
            newPlayer.play()
            manager.isPlaying = true
            manager.isMuted = newPlayer.isMuted
        case .failed:
            print("âŒ è§†é¢‘åŠ è½½å¤±è´¥")
            manager.isLoading = false
            manager.loadError = true
        case .unknown:
            print("â³ è§†é¢‘åŠ è½½ä¸­...")
        @unknown default:
            break
        }
    }
    .store(in: &manager.cancellables)
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼š**
- **é—®é¢˜**ï¼šAVPlayer çš„çŠ¶æ€å˜åŒ–å¯èƒ½å‘ç”Ÿåœ¨åå°çº¿ç¨‹
- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `.receive(on: DispatchQueue.main)` ç¡®ä¿æ‰€æœ‰ UI æ›´æ–°éƒ½åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ
- **å¥½å¤„**ï¼š
  - âœ… é¿å… UI æ›´æ–°å¯¼è‡´çš„çº¿ç¨‹å®‰å…¨é—®é¢˜
  - âœ… é˜²æ­¢å´©æºƒï¼ˆSwiftUI è§†å›¾æ›´æ–°å¿…é¡»åœ¨ä¸»çº¿ç¨‹ï¼‰
  - âœ… ç¡®ä¿çŠ¶æ€å˜åŒ–èƒ½ç«‹å³åæ˜ åˆ°ç•Œé¢ä¸Š

---

#### ğŸ“ ä½ç½® 2ï¼šé™éŸ³çŠ¶æ€ç›‘å¬

```swift
// ç›‘å¬ isMuted å±æ€§å˜åŒ–ï¼Œå®ç°åŒå‘ç»‘å®š
newPlayer.publisher(for: \.isMuted)
    .receive(on: DispatchQueue.main)
    .sink { [weak manager] isMuted in
        print("ğŸ”Š æ’­æ”¾å™¨é™éŸ³çŠ¶æ€å˜åŒ–: \(isMuted ? "é™éŸ³" : "æœ‰å£°")")
        manager?.isMuted = isMuted
    }
    .store(in: &manager.cancellables)
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼š**
- **é—®é¢˜**ï¼šç”¨æˆ·å¯èƒ½é€šè¿‡ç³»ç»Ÿæ§åˆ¶æ æˆ–è‡ªå®šä¹‰æŒ‰é’®æ”¹å˜é™éŸ³çŠ¶æ€
- **è§£å†³æ–¹æ¡ˆ**ï¼šç›‘å¬æ’­æ”¾å™¨çš„ `isMuted` å±æ€§ï¼ŒåŒæ­¥åˆ° UI çŠ¶æ€
- **å¥½å¤„**ï¼š
  - âœ… å®ç°åŒå‘æ•°æ®ç»‘å®š
  - âœ… ç¡®ä¿ UI å›¾æ ‡ä¸å®é™…çŠ¶æ€ä¸€è‡´
  - âœ… ä¸»çº¿ç¨‹æ›´æ–°é¿å…ç•Œé¢å¡é¡¿

---

#### ğŸ“ ä½ç½® 3ï¼šéŸ³é‡å˜åŒ–ç›‘å¬

```swift
// ç›‘å¬ volume å±æ€§å˜åŒ–ï¼Œç”¨äºè°ƒè¯•
newPlayer.publisher(for: \.volume)
    .receive(on: DispatchQueue.main)
    .sink { volume in
        print("ğŸ”Š éŸ³é‡å˜åŒ–: \(volume)")
    }
    .store(in: &manager.cancellables)
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼š**
- **é—®é¢˜**ï¼šéŸ³é‡å˜åŒ–å¯èƒ½æ¥è‡ªç³»ç»Ÿæˆ–ç”¨æˆ·æ“ä½œ
- **è§£å†³æ–¹æ¡ˆ**ï¼šç›‘å¬éŸ³é‡å˜åŒ–ï¼Œä¾¿äºè°ƒè¯•å’Œæ—¥å¿—è®°å½•
- **å¥½å¤„**ï¼š
  - âœ… å®æ—¶è¿½è¸ªéŸ³é‡çŠ¶æ€
  - âœ… æ–¹ä¾¿è°ƒè¯•éŸ³é¢‘é—®é¢˜
  - âœ… ä¸»çº¿ç¨‹æ‰§è¡Œç¡®ä¿æ—¥å¿—é¡ºåºæ­£ç¡®

---

### 2. ç½‘ç»œè¯·æ±‚å¤„ç† (`NetworkManager.swift`)

#### ğŸ“ ä½ç½®ï¼šAlamofire ç½‘ç»œè¯·æ±‚

```swift
@discardableResult
func requestGet(path: String, parameters: Parameters?, completion: @escaping NetworkRequestCompletion) -> DataRequest {
    AF.request(NetworkAPIBaseURL + path,
               parameters: parameters,
               headers: commonHeaders,
               requestModifier: { $0.timeoutInterval = 15 })
        .responseData { response in
            switch response.result {
            case let .success(data): completion(.success(data))
            case let .failure(error): completion(self.handleError(error))
            }
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼š**
- **é—®é¢˜**ï¼šç½‘ç»œè¯·æ±‚æ˜¯è€—æ—¶æ“ä½œï¼Œä¸èƒ½é˜»å¡ä¸»çº¿ç¨‹
- **è§£å†³æ–¹æ¡ˆ**ï¼šAlamofire è‡ªåŠ¨åœ¨åå°çº¿ç¨‹æ‰§è¡Œç½‘ç»œè¯·æ±‚ï¼Œå®Œæˆåé€šè¿‡å›è°ƒè¿”å›ç»“æœ
- **å¥½å¤„**ï¼š
  - âœ… ä¸»çº¿ç¨‹ä¸è¢«é˜»å¡ï¼ŒUI ä¿æŒå“åº”
  - âœ… ç”¨æˆ·å¯ä»¥ç»§ç»­æ»šåŠ¨ã€ç‚¹å‡»ç­‰æ“ä½œ
  - âœ… è¶…æ—¶è®¾ç½®ï¼ˆ15ç§’ï¼‰é¿å…æ— é™ç­‰å¾…
  - âœ… å¼‚æ­¥å›è°ƒæ¨¡å¼ä¾¿äºé”™è¯¯å¤„ç†

**çº¿ç¨‹æµç¨‹ï¼š**
```
ä¸»çº¿ç¨‹ â†’ å‘èµ·è¯·æ±‚ â†’ åå°çº¿ç¨‹æ‰§è¡Œç½‘ç»œè¯·æ±‚ â†’ å›è°ƒè¿”å›ä¸»çº¿ç¨‹ â†’ æ›´æ–°UI
```

---

### 3. æ•°æ®åŠ è½½ä¸åˆå§‹åŒ– (`PostListView.swift` & `HomeView.swift`)

#### ğŸ“ ä½ç½® 1ï¼šå¼‚æ­¥æ•°æ®åŠ è½½

```swift
.task {
    // ä½¿ç”¨ task ç¡®ä¿åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå¹¶ä¸”åªåœ¨é¦–æ¬¡åŠ è½½æ—¶æ‰§è¡Œ
    await loadInitialDataIfNeeded()
}

@MainActor
private func loadInitialDataIfNeeded() async {
    guard !hasLoadedInitialData else {
        return
    }
    
    hasLoadedInitialData = true
    
    // æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦å·²æœ‰æ•°æ®
    do {
        let descriptor = FetchDescriptor<Post>()
        let existingPosts = try modelContext.fetch(descriptor)
        
        if !existingPosts.isEmpty {
            print("âœ… æ•°æ®åº“å·²æœ‰ \(existingPosts.count) æ¡å¸–å­ï¼Œæ— éœ€åŠ è½½")
            return
        }
        
        print("ğŸ“¥ å¼€å§‹ä» JSON åŠ è½½åˆå§‹æ•°æ®...")
        isLoading = true
        
        let loadedPosts = JSONService.loadPostsFromJSON(
            fileName: "PostListData_recommend_2.json",
            modelContext: modelContext
        )
        
        isLoading = false
        
    } catch {
        isLoading = false
        hasLoadedInitialData = false
        print("âŒ æ£€æŸ¥æ•°æ®åº“æ—¶å‡ºé”™: \(error.localizedDescription)")
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼š**
- **é—®é¢˜**ï¼šä» JSON åŠ è½½æ•°æ®å’Œæ•°æ®åº“æŸ¥è¯¢æ˜¯è€—æ—¶æ“ä½œ
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - ä½¿ç”¨ `.task` ä¿®é¥°ç¬¦åœ¨è§†å›¾å‡ºç°æ—¶å¼‚æ­¥æ‰§è¡Œ
  - ä½¿ç”¨ `@MainActor` ç¡®ä¿ UI æ›´æ–°åœ¨ä¸»çº¿ç¨‹
  - ä½¿ç”¨ `async/await` è¯­æ³•ç®€åŒ–å¼‚æ­¥ä»£ç 
- **å¥½å¤„**ï¼š
  - âœ… ä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œç•Œé¢ç«‹å³æ˜¾ç¤º
  - âœ… æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
  - âœ… é¿å…é‡å¤åŠ è½½ï¼ˆé€šè¿‡æ ‡å¿—ä½æ§åˆ¶ï¼‰
  - âœ… ä»£ç æ›´æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤

**çº¿ç¨‹æµç¨‹ï¼š**
```
ä¸»çº¿ç¨‹ â†’ å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ â†’ åå°æ‰§è¡Œæ•°æ®åŠ è½½ â†’ ä¸»çº¿ç¨‹æ›´æ–°UIçŠ¶æ€
```

---

#### ğŸ“ ä½ç½® 2ï¼šHomeView æ•°æ®åŠ è½½

```swift
@MainActor
private func loadInitialData() async {
    guard !hasLoadedRecommend || !hasLoadedHot else {
        return
    }
    
    isLoading = true
    
    // åŠ è½½æ¨èæ•°æ®
    if !hasLoadedRecommend && recommendPosts.isEmpty {
        print("ğŸ“¥ å¼€å§‹åŠ è½½æ¨èæ•°æ®...")
        let loaded = JSONService.loadPostsFromJSON(
            fileName: "PostListData_recommend_2.json",
            modelContext: modelContext
        )
        hasLoadedRecommend = true
        print("âœ… æ¨èæ•°æ®åŠ è½½å®Œæˆ: \(loaded.count) æ¡")
    }
    
    // åŠ è½½çƒ­é—¨æ•°æ®
    if !hasLoadedHot && hotPosts.isEmpty {
        print("ğŸ“¥ å¼€å§‹åŠ è½½çƒ­é—¨æ•°æ®...")
        let loaded = JSONService.loadPostsFromJSON(
            fileName: "PostListData_hot_2.json",
            modelContext: modelContext
        )
        hasLoadedHot = true
        print("âœ… çƒ­é—¨æ•°æ®åŠ è½½å®Œæˆ: \(loaded.count) æ¡")
    }
    
    isLoading = false
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼š**
- **é—®é¢˜**ï¼šéœ€è¦åŠ è½½ä¸¤ä¸ªä¸åŒçš„æ•°æ®æºï¼ˆæ¨èå’Œçƒ­é—¨ï¼‰
- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `@MainActor` æ ‡è®°çš„å¼‚æ­¥å‡½æ•°ï¼Œé¡ºåºåŠ è½½æ•°æ®
- **å¥½å¤„**ï¼š
  - âœ… ç¡®ä¿æ•°æ®åŠ è½½é¡ºåºå¯æ§
  - âœ… é¿å…åŒæ—¶åŠ è½½å¯¼è‡´çš„èµ„æºç«äº‰
  - âœ… ç»Ÿä¸€çš„åŠ è½½çŠ¶æ€ç®¡ç†
  - âœ… ä¸»çº¿ç¨‹æ›´æ–° UIï¼Œé¿å…é—ªçƒ

---

### 4. æ•°æ®åŒæ­¥ä¸æŒä¹…åŒ– (`PostCellView.swift`)

#### ğŸ“ ä½ç½®ï¼šç‚¹èµçŠ¶æ€åŒæ­¥

```swift
.onChange(of: post.isLiked) { _, _ in
    // ç‚¹èµçŠ¶æ€æ”¹å˜æ—¶åŒæ­¥åˆ° JSON
    Task {
        try? modelContext.save()
        // æ ¹æ®å¸–å­IDåˆ¤æ–­å±äºå“ªä¸ªåˆ—è¡¨
        let fileName: String
        if post.id >= 1000 && post.id < 2000 {
            fileName = "PostListData_recommend_2.json"
        } else if post.id >= 2000 && post.id < 3000 {
            fileName = "PostListData_hot_2.json"
        } else if post.id >= 3000 && post.id < 4000 {
            fileName = "PostListData_recommend_2.json"
        } else {
            fileName = "PostListData_recommend_2.json"
        }
        JSONService.savePostsToJSON(fileName: fileName, modelContext: modelContext)
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼š**
- **é—®é¢˜**ï¼šç‚¹èµæ“ä½œéœ€è¦åŒæ—¶æ›´æ–°å†…å­˜ã€æ•°æ®åº“å’Œ JSON æ–‡ä»¶
- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `Task` åˆ›å»ºå¼‚æ­¥ä»»åŠ¡ï¼Œåœ¨åå°æ‰§è¡Œä¿å­˜æ“ä½œ
- **å¥½å¤„**ï¼š
  - âœ… UI ç«‹å³å“åº”ï¼Œä¸ç­‰å¾…ä¿å­˜å®Œæˆ
  - âœ… é¿å…é˜»å¡ä¸»çº¿ç¨‹
  - âœ… ç”¨æˆ·ä½“éªŒæµç•…ï¼Œæ— å¡é¡¿æ„Ÿ
  - âœ… æ•°æ®æŒä¹…åŒ–åœ¨åå°é™é»˜å®Œæˆ

**çº¿ç¨‹æµç¨‹ï¼š**
```
ä¸»çº¿ç¨‹ï¼ˆç‚¹èµï¼‰ â†’ åˆ›å»ºå¼‚æ­¥ä»»åŠ¡ â†’ åå°ä¿å­˜æ•°æ® â†’ ä¸»çº¿ç¨‹ç»§ç»­å“åº”ç”¨æˆ·æ“ä½œ
```

---

#### ğŸ“ ä½ç½®ï¼šåˆ é™¤æ“ä½œå»¶è¿Ÿæ‰§è¡Œ

```swift
// å»¶è¿Ÿåˆ é™¤ï¼Œç¡®ä¿åŠ¨ç”»å®Œæˆ
DispatchQueue.main.asyncAfter(deadline: .now() + 0.3) {
    withAnimation {
        modelContext.delete(post)
        do {
            try modelContext.save()
            print("âœ… å¸–å­ä»SwiftDataåˆ é™¤æˆåŠŸ")
            
            // åŒæ­¥åˆ°å¯¹åº”çš„JSONæ–‡ä»¶
            JSONService.savePostsToJSON(fileName: fileName, modelContext: modelContext)
            print("âœ… å·²åŒæ­¥åˆ°JSONæ–‡ä»¶: \(fileName)")
        } catch {
            print("âŒ åˆ é™¤å¤±è´¥: \(error)")
        }
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼š**
- **é—®é¢˜**ï¼šç«‹å³åˆ é™¤ä¼šå¯¼è‡´åŠ¨ç”»è¢«æ‰“æ–­ï¼Œç”¨æˆ·ä½“éªŒå·®
- **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `DispatchQueue.main.asyncAfter` å»¶è¿Ÿ 0.3 ç§’æ‰§è¡Œåˆ é™¤
- **å¥½å¤„**ï¼š
  - âœ… å¼¹çª—å…³é—­åŠ¨ç”»å®Œæ•´æ’­æ”¾
  - âœ… è§†è§‰æ•ˆæœæ›´æµç•…
  - âœ… é¿å…è§†å›¾çªç„¶æ¶ˆå¤±çš„çªå…€æ„Ÿ
  - âœ… ç»™ç”¨æˆ·è¶³å¤Ÿçš„è§†è§‰åé¦ˆæ—¶é—´

---

### 5. ç½‘ç»œå›¾ç‰‡åŠ è½½ (`ImageLoader.swift`)

#### ğŸ“ ä½ç½®ï¼šSDWebImage å¼‚æ­¥åŠ è½½

```swift
struct NetworkImageView: View {
    let imageURL: String
    
    var body: some View {
        WebImage(url: URL(string: NetworkAPIBaseURL + imageURL)) { image in
            image
                .resizable()
        } placeholder: {
            // åŠ è½½ä¸­çš„å ä½è§†å›¾
            ShimmerPlaceholder()
        }
        .onSuccess { image, data, cacheType in
            // å›¾ç‰‡åŠ è½½æˆåŠŸ
        }
        .onFailure { error in
            // å›¾ç‰‡åŠ è½½å¤±è´¥
            print("å›¾ç‰‡åŠ è½½å¤±è´¥: \(error.localizedDescription)")
        }
        .indicator(Indicator.activity)
        .transition(AnyTransition.opacity.animation(.easeInOut(duration: 0.3)))
    }
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·åšï¼š**
- **é—®é¢˜**ï¼šç½‘ç»œå›¾ç‰‡åŠ è½½æ˜¯è€—æ—¶æ“ä½œï¼Œå¯èƒ½éœ€è¦å‡ ç§’é’Ÿ
- **è§£å†³æ–¹æ¡ˆ**ï¼šSDWebImage è‡ªåŠ¨åœ¨åå°çº¿ç¨‹ä¸‹è½½å’Œè§£ç å›¾ç‰‡
- **å¥½å¤„**ï¼š
  - âœ… ä¸»çº¿ç¨‹ä¸è¢«é˜»å¡ï¼Œåˆ—è¡¨æ»šåŠ¨æµç•…
  - âœ… è‡ªåŠ¨ç¼“å­˜ï¼Œé¿å…é‡å¤ä¸‹è½½
  - âœ… å ä½å›¾æä¾›å³æ—¶åé¦ˆ
  - âœ… æ·¡å…¥åŠ¨ç”»æå‡è§†è§‰ä½“éªŒ
  - âœ… å†…å­˜ç®¡ç†è‡ªåŠ¨åŒ–ï¼Œé¿å…å†…å­˜æº¢å‡º

**çº¿ç¨‹æµç¨‹ï¼š**
```
ä¸»çº¿ç¨‹ï¼ˆæ˜¾ç¤ºå ä½å›¾ï¼‰ â†’ åå°çº¿ç¨‹ä¸‹è½½å›¾ç‰‡ â†’ åå°çº¿ç¨‹è§£ç  â†’ ä¸»çº¿ç¨‹æ˜¾ç¤ºå›¾ç‰‡
```

---

## è¯¦ç»†åˆ†æ

### ğŸ¯ å¤šçº¿ç¨‹çš„æ ¸å¿ƒç›®æ ‡

åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œå¤šçº¿ç¨‹æŠ€æœ¯çš„ä½¿ç”¨éµå¾ªä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š

1. **ä¸»çº¿ç¨‹ä¸“æ³¨ UI**
   - æ‰€æœ‰ UI æ›´æ–°å¿…é¡»åœ¨ä¸»çº¿ç¨‹
   - ä½¿ç”¨ `@MainActor` æ ‡è®° UI ç›¸å…³å‡½æ•°
   - ä½¿ç”¨ `.receive(on: DispatchQueue.main)` åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹

2. **åå°çº¿ç¨‹å¤„ç†è€—æ—¶æ“ä½œ**
   - ç½‘ç»œè¯·æ±‚
   - æ–‡ä»¶è¯»å†™
   - æ•°æ®åº“æŸ¥è¯¢
   - å›¾ç‰‡è§£ç 

3. **å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼**
   - ä½¿ç”¨ `async/await` ç®€åŒ–å¼‚æ­¥ä»£ç 
   - ä½¿ç”¨ `Task` åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
   - ä½¿ç”¨ `Combine` å¤„ç†äº‹ä»¶æµ

---

### ğŸ”„ çº¿ç¨‹åˆ‡æ¢æ—¶æœº

#### 1. ç½‘ç»œè¯·æ±‚
```
ä¸»çº¿ç¨‹ â†’ å‘èµ·è¯·æ±‚ â†’ åå°çº¿ç¨‹ â†’ å›è°ƒä¸»çº¿ç¨‹ â†’ æ›´æ–°UI
```

#### 2. è§†é¢‘æ’­æ”¾
```
ä¸»çº¿ç¨‹ â†’ åˆ›å»ºæ’­æ”¾å™¨ â†’ åå°åŠ è½½è§†é¢‘ â†’ çŠ¶æ€å›è°ƒä¸»çº¿ç¨‹ â†’ æ›´æ–°UI
```

#### 3. æ•°æ®åŠ è½½
```
ä¸»çº¿ç¨‹ â†’ å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ â†’ åå°è¯»å–æ–‡ä»¶ â†’ ä¸»çº¿ç¨‹æ›´æ–°çŠ¶æ€
```

#### 4. å›¾ç‰‡åŠ è½½
```
ä¸»çº¿ç¨‹ â†’ æ˜¾ç¤ºå ä½å›¾ â†’ åå°ä¸‹è½½ â†’ åå°è§£ç  â†’ ä¸»çº¿ç¨‹æ˜¾ç¤º
```

---

### âš ï¸ å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

#### é™·é˜± 1ï¼šåœ¨åå°çº¿ç¨‹æ›´æ–° UI
```swift
// âŒ é”™è¯¯ç¤ºä¾‹
DispatchQueue.global().async {
    self.isLoading = false  // å´©æºƒï¼
}

// âœ… æ­£ç¡®ç¤ºä¾‹
DispatchQueue.global().async {
    DispatchQueue.main.async {
        self.isLoading = false
    }
}

// âœ… æ›´å¥½çš„æ–¹å¼ï¼ˆä½¿ç”¨ Combineï¼‰
publisher
    .receive(on: DispatchQueue.main)
    .sink { value in
        self.isLoading = false
    }
```

#### é™·é˜± 2ï¼šé˜»å¡ä¸»çº¿ç¨‹
```swift
// âŒ é”™è¯¯ç¤ºä¾‹
func loadData() {
    let data = try? Data(contentsOf: url)  // é˜»å¡ä¸»çº¿ç¨‹
    self.data = data
}

// âœ… æ­£ç¡®ç¤ºä¾‹
func loadData() async {
    let data = try? await URLSession.shared.data(from: url)
    await MainActor.run {
        self.data = data.0
    }
}
```

#### é™·é˜± 3ï¼šå¾ªç¯å¼•ç”¨
```swift
// âŒ é”™è¯¯ç¤ºä¾‹
player.publisher(for: \.status)
    .sink { status in
        self.manager.isLoading = false  // å¯èƒ½å¯¼è‡´å¾ªç¯å¼•ç”¨
    }

// âœ… æ­£ç¡®ç¤ºä¾‹
player.publisher(for: \.status)
    .sink { [weak manager] status in
        manager?.isLoading = false
    }
```

---

## æœ€ä½³å®è·µæ€»ç»“

### âœ… æ¨èåšæ³•

1. **ä½¿ç”¨ @MainActor æ ‡è®° UI ç›¸å…³ä»£ç **
   ```swift
   @MainActor
   func updateUI() {
       // æ‰€æœ‰ UI æ›´æ–°ä»£ç 
   }
   ```

2. **ä½¿ç”¨ async/await æ›¿ä»£å›è°ƒåœ°ç‹±**
   ```swift
   // æ¸…æ™°çš„å¼‚æ­¥æµç¨‹
   func loadData() async {
       let data = await fetchData()
       await processData(data)
       await updateUI()
   }
   ```

3. **ä½¿ç”¨ Combine å¤„ç†äº‹ä»¶æµ**
   ```swift
   player.publisher(for: \.status)
       .receive(on: DispatchQueue.main)
       .sink { status in
           // å¤„ç†çŠ¶æ€å˜åŒ–
       }
   ```

4. **ä½¿ç”¨ Task åˆ›å»ºå¼‚æ­¥ä»»åŠ¡**
   ```swift
   Task {
       await performAsyncWork()
   }
   ```

5. **ä½¿ç”¨ weak self é¿å…å¾ªç¯å¼•ç”¨**
   ```swift
   .sink { [weak self] value in
       self?.updateValue(value)
   }
   ```

---

### âŒ é¿å…çš„åšæ³•

1. **ä¸è¦åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œè€—æ—¶æ“ä½œ**
   - ç½‘ç»œè¯·æ±‚
   - å¤§æ–‡ä»¶è¯»å†™
   - å¤æ‚è®¡ç®—

2. **ä¸è¦åœ¨åå°çº¿ç¨‹æ›´æ–° UI**
   - å¿…é¡»åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹

3. **ä¸è¦å¿˜è®°å¤„ç†å†…å­˜æ³„æ¼**
   - ä½¿ç”¨ `[weak self]` æˆ– `[unowned self]`

4. **ä¸è¦è¿‡åº¦ä½¿ç”¨ DispatchQueue.main.async**
   - ä¼˜å…ˆä½¿ç”¨ `@MainActor` å’Œ `async/await`

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å›¾ç‰‡åŠ è½½ä¼˜åŒ–
- âœ… ä½¿ç”¨ SDWebImage è‡ªåŠ¨ç¼“å­˜
- âœ… æ‡’åŠ è½½ï¼ŒåªåŠ è½½å¯è§å›¾ç‰‡
- âœ… é™é‡‡æ ·å¤§å›¾ç‰‡

### 2. è§†é¢‘æ’­æ”¾ä¼˜åŒ–
- âœ… é¢„åŠ è½½è§†é¢‘å…ƒæ•°æ®
- âœ… ä½¿ç”¨ AVPlayerLayer å¤ç”¨
- âœ… åŠæ—¶é‡Šæ”¾ä¸å¯è§çš„æ’­æ”¾å™¨

### 3. æ•°æ®åŠ è½½ä¼˜åŒ–
- âœ… åˆ†é¡µåŠ è½½ï¼Œé¿å…ä¸€æ¬¡åŠ è½½è¿‡å¤šæ•°æ®
- âœ… ä½¿ç”¨ LazyVStack å»¶è¿Ÿæ¸²æŸ“
- âœ… ç¼“å­˜å·²åŠ è½½çš„æ•°æ®

### 4. ç½‘ç»œè¯·æ±‚ä¼˜åŒ–
- âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- âœ… ä½¿ç”¨è¯·æ±‚é˜Ÿåˆ—æ§åˆ¶å¹¶å‘æ•°
- âœ… å®ç°è¯·æ±‚å–æ¶ˆæœºåˆ¶

---

## ğŸ“ å­¦ä¹ è¦ç‚¹

### å…³é”®æ¦‚å¿µ

1. **ä¸»çº¿ç¨‹ï¼ˆMain Threadï¼‰**
   - è´Ÿè´£ UI æ¸²æŸ“å’Œç”¨æˆ·äº¤äº’
   - å¿…é¡»ä¿æŒæµç•…ï¼Œä¸èƒ½é˜»å¡

2. **åå°çº¿ç¨‹ï¼ˆBackground Threadï¼‰**
   - å¤„ç†è€—æ—¶æ“ä½œ
   - ä¸èƒ½ç›´æ¥æ›´æ–° UI

3. **çº¿ç¨‹å®‰å…¨ï¼ˆThread Safetyï¼‰**
   - é¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€æ•°æ®
   - ä½¿ç”¨ `@MainActor` ç¡®ä¿çº¿ç¨‹å®‰å…¨

4. **å¼‚æ­¥ç¼–ç¨‹ï¼ˆAsynchronous Programmingï¼‰**
   - ä¸é˜»å¡å½“å‰çº¿ç¨‹
   - ä½¿ç”¨å›è°ƒã€Promiseã€async/await

### Swift å¹¶å‘å·¥å…·

1. **GCD (Grand Central Dispatch)**
   - `DispatchQueue.main`
   - `DispatchQueue.global()`
   - `asyncAfter`

2. **Async/Await**
   - `async` å‡½æ•°
   - `await` å…³é”®å­—
   - `Task` åˆ›å»ºå¼‚æ­¥ä»»åŠ¡

3. **Combine**
   - `Publisher` å‘å¸ƒè€…
   - `Subscriber` è®¢é˜…è€…
   - `receive(on:)` åˆ‡æ¢çº¿ç¨‹

4. **Actor**
   - `@MainActor` ä¸»çº¿ç¨‹æ‰§è¡Œ
   - è‡ªåŠ¨çº¿ç¨‹å®‰å…¨

---

## ğŸ“ æ€»ç»“

æœ¬é¡¹ç›®é€šè¿‡åˆç†ä½¿ç”¨å¤šçº¿ç¨‹æŠ€æœ¯ï¼Œå®ç°äº†ï¼š

- âœ… **æµç•…çš„ç”¨æˆ·ä½“éªŒ**ï¼šä¸»çº¿ç¨‹ä¸è¢«é˜»å¡ï¼Œç•Œé¢å“åº”è¿…é€Ÿ
- âœ… **é«˜æ•ˆçš„èµ„æºåˆ©ç”¨**ï¼šåå°çº¿ç¨‹å¤„ç†è€—æ—¶æ“ä½œï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU
- âœ… **ç¨³å®šçš„åº”ç”¨æ€§èƒ½**ï¼šé¿å… UI å¡é¡¿å’Œ ANRï¼ˆApplication Not Respondingï¼‰
- âœ… **ä¼˜é›…çš„ä»£ç ç»“æ„**ï¼šä½¿ç”¨ç°ä»£ Swift å¹¶å‘ç‰¹æ€§ï¼Œä»£ç æ¸…æ™°æ˜“ç»´æŠ¤

å¤šçº¿ç¨‹æ˜¯ç°ä»£ç§»åŠ¨åº”ç”¨å¼€å‘çš„åŸºç¡€æŠ€èƒ½ï¼ŒæŒæ¡å®ƒèƒ½è®©ä½ çš„åº”ç”¨æ›´åŠ æµç•…ã€é«˜æ•ˆã€ç”¨æˆ·å‹å¥½ï¼

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-01-27  
**é€‚ç”¨é¡¹ç›®**: newTestSwiftData (ç±»å¾®åšç¤¾äº¤åº”ç”¨)



